<!-- src/app/admin/components/assign-modules-dialog/assign-modules-dialog.component.html -->
<div class="max-w-[700px]">
  
    <!-- ============================================
         HEADER
         ============================================ -->
    <div class="flex justify-between items-center px-8 py-6 bg-gradient-to-br from-purple-500 to-purple-600 text-white">
      <div class="flex items-center gap-4">
        <div class="w-14 h-14 bg-white/20 rounded-xl flex items-center justify-center backdrop-blur-xl">
          <mat-icon class="!text-[28px]">apps</mat-icon>
        </div>
        <div>
          <h2 class="text-2xl font-bold mb-1">Asignar Módulos</h2>
          <p class="text-purple-100 text-sm">
            Gestiona los módulos de {{ data.user.displayName }}
          </p>
        </div>
      </div>
      <button
        mat-icon-button
        (click)="onCancel()"
        class="!text-white !bg-white/10 hover:!bg-white/20"
        [disabled]="isSaving"
        aria-label="Cerrar diálogo">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  
    <!-- ============================================
         CONTENT
         ============================================ -->
    <div class="px-8 py-6 max-h-[70vh] overflow-y-auto">
      
      <!-- Info del usuario -->
      <div class="bg-gradient-to-br from-purple-50 to-purple-100 border-2 border-purple-200 rounded-xl p-4 mb-6">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-lg flex items-center justify-center text-white font-bold"
               [style.background-color]="getAvatarColor(data.user.email)">
            {{ getInitials(data.user.displayName) }}
          </div>
          <div class="flex-1">
            <div class="font-semibold text-slate-800 text-sm">{{ data.user.displayName }}</div>
            <div class="text-xs text-slate-600">{{ data.user.email }}</div>
          </div>
          <div class="flex items-center gap-2">
            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-md text-xs font-semibold border"
                  [ngClass]="{
                    'bg-amber-100 text-amber-700 border-amber-200': data.user.role === 'admin',
                    'bg-blue-100 text-blue-700 border-blue-200': data.user.role === 'user',
                    'bg-purple-100 text-purple-700 border-purple-200': data.user.role === 'viewer'
                  }">
              {{ data.user.role.toUpperCase() }}
            </span>
            <span class="text-xs text-slate-500 font-medium">
              • {{ getSelectedCount() }} módulo(s) seleccionado(s)
            </span>
          </div>
        </div>
      </div>
  
      <!-- Loading state -->
      @if (isLoading) {
        <div class="flex items-center justify-center py-8">
          <mat-spinner diameter="40"></mat-spinner>
          <span class="ml-3 text-slate-600">Cargando módulos...</span>
        </div>
      }
  
      <!-- Grid de módulos -->
      @if (!isLoading && availableModules.length > 0) {
        <div class="space-y-4">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-base font-bold text-slate-800">
              Módulos Disponibles
            </h3>
            <div class="flex gap-2">
              <button
                type="button"
                (click)="selectAll()"
                [disabled]="areAllSelected()"
                class="inline-flex items-center gap-1 h-8 px-3 text-xs font-semibold border-2 border-slate-200 text-slate-600 rounded-lg bg-white hover:bg-slate-50 hover:border-slate-300 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                <mat-icon class="!text-base">check_box</mat-icon>
                Seleccionar todos
              </button>
              <button
                type="button"
                (click)="deselectAll()"
                [disabled]="selectedModules.size === 0"
                class="inline-flex items-center gap-1 h-8 px-3 text-xs font-semibold border-2 border-slate-200 text-slate-600 rounded-lg bg-white hover:bg-slate-50 hover:border-slate-300 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
                <mat-icon class="!text-base">check_box_outline_blank</mat-icon>
                Quitar todos
              </button>
            </div>
          </div>
  
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            @for (module of availableModules; track module.id) {
              <div 
                class="module-card flex items-center gap-3 p-4 bg-white border-2 rounded-xl cursor-pointer transition-all hover:shadow-md"
                [class.selected]="isModuleSelected(module.value)"
                [class.border-purple-500]="isModuleSelected(module.value)"
                [class.bg-purple-50]="isModuleSelected(module.value)"
                [class.border-slate-200]="!isModuleSelected(module.value)"
                [class.opacity-50]="!module.isActive"
                (click)="toggleModule(module.value)">
                
                <!-- Checkbox -->
                <mat-checkbox 
                  [checked]="isModuleSelected(module.value)"
                  [disabled]="!module.isActive"
                  (change)="toggleModule(module.value)"
                  (click)="$event.stopPropagation()"
                  color="primary"
                  class="flex-shrink-0">
                </mat-checkbox>
                
                <!-- Icon -->
                <div class="w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0"
                     [class.bg-purple-500]="isModuleSelected(module.value)"
                     [class.bg-slate-200]="!isModuleSelected(module.value)">
                  <mat-icon class="!text-xl"
                            [class.text-white]="isModuleSelected(module.value)"
                            [class.text-slate-500]="!isModuleSelected(module.value)">
                    {{ module.icon }}
                  </mat-icon>
                </div>
                
                <!-- Content SIMPLIFICADO -->
                <div class="flex-1 min-w-0">
                  <span class="text-sm font-semibold text-slate-800">{{ module.label }}</span>
                  @if (!module.isActive) {
                    <span class="ml-2 text-xs bg-amber-100 text-amber-700 px-2 py-0.5 rounded-md font-semibold">
                      Inactivo
                    </span>
                  }
                </div>
              </div>
            }
          </div>
  
          <!-- Resumen de cambios -->
          @if (hasChanges()) {
            <div class="bg-blue-50 border border-blue-200 rounded-xl p-4 mt-6">
              <div class="flex items-start gap-3">
                <mat-icon class="!text-xl text-blue-600 mt-0.5">info</mat-icon>
                <div class="flex-1">
                  <p class="text-sm font-semibold text-blue-900 mb-2">
                    Resumen de cambios:
                  </p>
                  
                  @if (getAddedModules().length > 0) {
                    <div class="mb-2">
                      <span class="text-xs font-semibold text-green-700">Se agregarán:</span>
                      <div class="flex flex-wrap gap-1.5 mt-1">
                        @for (moduleValue of getAddedModules(); track moduleValue) {
                          <span class="inline-flex items-center gap-1 px-2 py-1 bg-green-100 text-green-800 rounded-md text-xs font-medium">
                            <mat-icon class="!text-xs">add</mat-icon>
                            {{ getModuleLabel(moduleValue) }}
                          </span>
                        }
                      </div>
                    </div>
                  }
                  
                  @if (getRemovedModules().length > 0) {
                    <div>
                      <span class="text-xs font-semibold text-red-700">Se quitarán:</span>
                      <div class="flex flex-wrap gap-1.5 mt-1">
                        @for (moduleValue of getRemovedModules(); track moduleValue) {
                          <span class="inline-flex items-center gap-1 px-2 py-1 bg-red-100 text-red-800 rounded-md text-xs font-medium">
                            <mat-icon class="!text-xs">remove</mat-icon>
                            {{ getModuleLabel(moduleValue) }}
                          </span>
                        }
                      </div>
                    </div>
                  }
                </div>
              </div>
            </div>
          }
        </div>
      }
  
      <!-- Empty state -->
      @if (!isLoading && availableModules.length === 0) {
        <div class="text-center py-8">
          <mat-icon class="!text-5xl text-slate-300">apps_outline</mat-icon>
          <p class="mt-3 text-slate-600">No hay módulos configurados en el sistema</p>
          <button
            type="button"
            (click)="goToModulesConfig()"
            class="inline-flex items-center gap-2 mt-4 px-5 py-2.5 bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl text-sm font-semibold shadow-lg hover:shadow-xl transition-all">
            <mat-icon class="!text-lg">settings</mat-icon>
            Configurar Módulos
          </button>
        </div>
      }

    </div>

    <!-- ============================================
         ACTIONS
         ============================================ -->
    <div class="px-8 py-4 border-t border-slate-200 flex gap-3 justify-end">
      <button
        type="button"
        (click)="onCancel()"
        [disabled]="isSaving"
        class="inline-flex items-center gap-2 px-5 py-2.5 border-2 border-slate-200 text-slate-600 rounded-xl text-sm font-semibold bg-white hover:bg-slate-50 hover:border-slate-300 transition-all disabled:opacity-50 disabled:cursor-not-allowed">
        <mat-icon class="!text-lg">close</mat-icon>
        Cancelar
      </button>

      <button
        type="button"
        (click)="onSave()"
        [disabled]="isSaving || !hasChanges()"
        class="inline-flex items-center gap-2 px-5 py-2.5 bg-gradient-to-br from-purple-500 to-purple-600 text-white rounded-xl text-sm font-semibold shadow-lg hover:shadow-xl transition-all disabled:opacity-50 disabled:cursor-not-allowed">
        @if (isSaving) {
          <mat-spinner diameter="20" class="mr-2"></mat-spinner>
        } @else {
          <mat-icon>save</mat-icon>
        }
        {{ isSaving ? 'Guardando...' : 'Guardar Cambios' }}
      </button>
    </div>

  </div>