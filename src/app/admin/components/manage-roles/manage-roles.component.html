<!-- manage-roles.component.html -->
<div class="min-h-screen">
  <div class="app-container">

    <!-- ========== HEADER - Usando ModuleHeaderComponent ========== -->
    <app-module-header
      icon="admin_panel_settings"
      [title]="getHeaderTitle()"
      [subtitle]="getHeaderSubtitle()"
      moduleColor="blue"
      [showBackButton]="true"
      [backButtonTooltip]="getBackTooltip()"
      [stats]="getHeaderStats()"
      [actionButtons]="getHeaderActions()"
      [primaryButtonLabel]="viewMode === 'list' ? 'Nuevo Rol' : ''"
      (backAction)="handleBackAction()"
      (primaryAction)="showAddRole()">
    </app-module-header>

    <!-- CONTENT -->
    <div>

    <!-- MODO LISTA -->
    @if (viewMode === 'list') {
      <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5">
        @if (isLoading) {
          <div class="flex justify-center items-center py-20">
            <mat-spinner diameter="40"></mat-spinner>
          </div>
        } @else {
          <div class="roles-list flex flex-col gap-2">
            @for (role of roles; track role.id) {
              <div class="role-row group"
                   [class.inactive]="!role.isActive">

                <!-- Role Icon -->
                <div class="role-icon"
                     [class.admin]="role.value === 'admin'"
                     [class.user]="role.value === 'user'"
                     [class.viewer]="role.value === 'viewer'"
                     [class.custom]="!role.isSystemRole">
                  <mat-icon>{{ getRoleIcon(role.value) }}</mat-icon>
                </div>

                <!-- Role Info -->
                <div class="flex-1 min-w-0">
                  <div class="flex items-center gap-2 mb-0.5">
                    <h3 class="text-sm font-bold text-slate-800 truncate">
                      {{ role.label }}
                    </h3>
                    @if (!role.isActive) {
                      <span class="badge-sm inactive">Inactivo</span>
                    }
                  </div>
                  <p class="text-xs text-slate-500 truncate">{{ role.description }}</p>
                </div>

                <!-- Meta Info -->
                <div class="hidden md:flex items-center gap-3">
                  <span class="meta-info">
                    <mat-icon>code</mat-icon>
                    <code>{{ role.value }}</code>
                  </span>
                  <span class="meta-info">
                    <mat-icon>security</mat-icon>
                    {{ role.permissions.length }} permisos
                  </span>
                  <span class="meta-info users">
                    <mat-icon>people</mat-icon>
                    {{ role.userCount || 0 }}
                  </span>
                </div>

                <!-- Actions -->
                <div class="flex items-center gap-1">
                  <button
                    mat-icon-button
                    class="action-btn"
                    (click)="showEditRole(role)"
                    matTooltip="Editar">
                    <mat-icon>edit</mat-icon>
                  </button>

                  @if (!role.isSystemRole) {
                    <button
                      mat-icon-button
                      class="action-btn delete"
                      (click)="deleteRole(role)"
                      matTooltip="Eliminar">
                      <mat-icon>delete</mat-icon>
                    </button>
                  }
                </div>

              </div>
            }
          </div>
        }
      </div>
    }

    <!-- ============================================
         MODO AGREGAR/EDITAR - FORMULARIO
         ============================================ -->
    @if (viewMode === 'add' || viewMode === 'edit') {
      <div>
        <form [formGroup]="roleForm">

          <!-- Información Básica -->
          <div class="mb-8">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
              <mat-icon class="text-blue-500">info</mat-icon>
              Información Básica
            </h3>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
              <!-- Value -->
              <div class="input-group flex flex-col gap-2">
                <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
                  <mat-icon class="label-icon !text-lg text-blue-500">vpn_key</mat-icon>
                  Identificador
                  @if (selectedRole?.isSystemRole) {
                    <span class="text-xs font-normal text-slate-500">(No editable)</span>
                  }
                </label>
                <input
                  type="text"
                  class="input-field"
                  formControlName="value"
                  placeholder="ej: editor, manager"
                  [readonly]="selectedRole?.isSystemRole">
                @if (isFieldInvalid('value')) {
                  <div class="input-error">
                    {{ getErrorMessage('value') }}
                  </div>
                }
                <span class="text-xs text-slate-500">Solo letras minúsculas y guiones bajos</span>
              </div>

              <!-- Label -->
              <div class="input-group flex flex-col gap-2">
                <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
                  <mat-icon class="label-icon !text-lg text-blue-500">label</mat-icon>
                  Nombre del Rol
                </label>
                <input
                  type="text"
                  class="input-field"
                  formControlName="label"
                  placeholder="ej: Editor de Contenido">
                @if (isFieldInvalid('label')) {
                  <div class="input-error">
                    {{ getErrorMessage('label') }}
                  </div>
                }
              </div>
            </div>

            <!-- Description -->
            <div class="input-group flex flex-col gap-2 mb-6">
              <label class="input-label flex items-center gap-2 text-sm font-semibold text-slate-800">
                <mat-icon class="label-icon !text-lg text-blue-500">description</mat-icon>
                Descripción
              </label>
              <textarea
                class="input-field resize-none"
                formControlName="description"
                rows="3"
                placeholder="Describe las responsabilidades de este rol..."></textarea>
              @if (isFieldInvalid('description')) {
                <div class="input-error">
                  {{ getErrorMessage('description') }}
                </div>
              }
            </div>

            <!-- Active Status -->
            <div class="status-section bg-green-50 border border-green-200 rounded-xl p-5">
              <mat-checkbox
                formControlName="isActive"
                class="status-checkbox w-full"
                color="primary">
                <div class="checkbox-content flex flex-col gap-1">
                  <span class="checkbox-label text-[15px] font-semibold text-green-800">Rol Activo</span>
                  <span class="checkbox-hint text-sm text-green-600 italic">El rol estará disponible para asignar a usuarios</span>
                </div>
              </mat-checkbox>
            </div>
          </div>

          <mat-divider class="my-8"></mat-divider>

          <!-- Permisos -->
          <div>
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
              <mat-icon class="text-blue-500">security</mat-icon>
              Permisos del Rol
            </h3>

            <div class="permissions-grid grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
              @for (permission of permissionOptions; track permission.value) {
                <div
                  class="permission-card flex items-start gap-3 p-4 border-2 rounded-xl cursor-pointer hover:border-blue-300 transition-all"
                  [class.border-blue-500]="isPermissionSelected(permission.value)"
                  [class.bg-blue-50]="isPermissionSelected(permission.value)"
                  [class.border-slate-200]="!isPermissionSelected(permission.value)"
                  (click)="togglePermission(permission.value)">

                  <mat-checkbox
                    [checked]="isPermissionSelected(permission.value)"
                    (change)="togglePermission(permission.value)"
                    (click)="$event.stopPropagation()"
                    color="primary"
                    class="permission-checkbox flex-shrink-0">
                  </mat-checkbox>

                  <div class="permission-content flex items-start gap-3 flex-1">
                    <mat-icon class="permission-icon !text-2xl text-blue-500 flex-shrink-0 mt-1">
                      {{ getPermissionIcon(permission.value) }}
                    </mat-icon>
                    <div>
                      <h4 class="permission-name text-sm font-semibold text-slate-800 m-0 mb-1">{{ permission.label }}</h4>
                      <p class="permission-desc text-xs text-slate-500 m-0">{{ permission.description }}</p>
                    </div>
                  </div>
                </div>
              }
            </div>

            @if (roleForm.get('permissions')?.invalid && (roleForm.get('permissions')?.dirty || roleForm.get('permissions')?.touched)) {
              <div class="text-red-500 text-sm font-medium mb-4">
                Debes seleccionar al menos un permiso
              </div>
            }

            <!-- Preview -->
            @if (roleForm.get('permissions')?.value?.length > 0) {
              <div class="selected-preview bg-slate-50 border border-slate-200 rounded-xl p-4">
                <span class="preview-label block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-3">
                  Permisos seleccionados ({{ roleForm.get('permissions')?.value?.length }})
                </span>
                <mat-chip-set class="modern-chip-set flex flex-wrap gap-2">
                  @for (perm of roleForm.get('permissions')?.value; track perm) {
                    <mat-chip
                      class="modern-chip permission-chip"
                      (removed)="togglePermission(perm)">
                      <mat-icon matChipAvatar class="!text-base">{{ getPermissionIcon(perm) }}</mat-icon>
                      {{ getPermissionLabel(perm) }}
                      <button matChipRemove>
                        <mat-icon>cancel</mat-icon>
                      </button>
                    </mat-chip>
                  }
                </mat-chip-set>
              </div>
            }
          </div>

        </form>
      </div>
    }

  </div>

  <!-- FOOTER (solo en modo add/edit) -->
  @if (viewMode !== 'list') {
    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 shadow-lg z-50">
      <div class="mx-auto px-5 py-4 flex justify-end gap-3" style="max-width: var(--container-max-width)">
        <button
          mat-button
          (click)="backToList()"
          [disabled]="isLoading"
          class="text-slate-600 font-medium">
          Cancelar
        </button>
        <button
          mat-raised-button
          (click)="saveRole()"
          [disabled]="roleForm.invalid || isLoading"
          class="!bg-blue-600 !text-white font-semibold">
          @if (isLoading) {
            <mat-spinner diameter="18" class="inline-block mr-2"></mat-spinner>
          } @else {
            <mat-icon>{{ viewMode === 'add' ? 'add' : 'save' }}</mat-icon>
          }
          {{ isLoading ? 'Guardando...' : (viewMode === 'add' ? 'Crear Rol' : 'Guardar') }}
        </button>
      </div>
    </div>
  }

</div>
