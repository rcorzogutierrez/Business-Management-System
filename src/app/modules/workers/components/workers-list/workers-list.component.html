<!-- workers-list.component.html - DISEÑO COMPACTO CON TAILWIND -->
<div class="max-w-[1200px] mx-auto p-5">

  <!-- ============================================
       HEADER COMPACTO
       ============================================ -->
  <header class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 mb-5 animate-fadeIn">
    <div class="flex items-center justify-between gap-4 flex-wrap">

      <!-- Left Section -->
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl flex items-center justify-center bg-gradient-amber shadow-lg shadow-amber-500/30">
          <mat-icon class="!text-white !text-xl">engineering</mat-icon>
        </div>
        <div>
          <h1 class="text-lg font-bold text-slate-800">Gestión de Trabajadores</h1>
          <p class="text-xs text-slate-500">
            {{ stats().total }} registros en el sistema
          </p>
        </div>
      </div>

      <!-- Right Section - Stats & Actions -->
      <div class="flex items-center gap-3 flex-wrap">
        <!-- Stats inline -->
        <div class="hidden md:flex items-center gap-2">
          <div class="flex flex-col items-center rounded-lg px-3 py-1.5 min-w-[65px] bg-emerald-50 border border-emerald-200">
            <span class="text-[15px] font-bold leading-none text-emerald-600">{{ stats().active }}</span>
            <span class="text-[9px] uppercase tracking-wide mt-0.5 text-emerald-500">Activos</span>
          </div>
          <div class="flex flex-col items-center rounded-lg px-3 py-1.5 min-w-[65px] bg-blue-50 border border-blue-200">
            <span class="text-[15px] font-bold leading-none text-blue-600">{{ stats().internal }}</span>
            <span class="text-[9px] uppercase tracking-wide mt-0.5 text-blue-500">Propios</span>
          </div>
          <div class="flex flex-col items-center rounded-lg px-3 py-1.5 min-w-[65px] bg-purple-50 border border-purple-200">
            <span class="text-[15px] font-bold leading-none text-purple-600">{{ stats().contractor }}</span>
            <span class="text-[9px] uppercase tracking-wide mt-0.5 text-purple-500">Subcontrat.</span>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex items-center gap-2">
          <button type="button"
                  class="w-9 h-9 rounded-lg bg-slate-50 border border-slate-200 flex items-center justify-center cursor-pointer transition-all hover:bg-slate-100 hover:border-slate-300 hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed"
                  (click)="refresh()"
                  [disabled]="isLoading()"
                  title="Actualizar">
            <mat-icon class="!text-slate-600 !text-lg" [class.animate-spin]="isLoading()">refresh</mat-icon>
          </button>

          <!-- Selector de Columnas -->
          @if (config()?.gridConfig?.enableColumnSelector !== false) {
            <app-column-visibility-control
              [columns]="columnOptions()"
              [storageKey]="'workers-visible-columns'"
              [defaultVisibleColumns]="defaultVisibleColumnIds()"
              [themeColor]="'amber'"
              (visibilityChange)="onColumnVisibilityChange($event)">
            </app-column-visibility-control>
          }

          <!-- Botón de Exportar -->
          @if (config()?.gridConfig?.enableExport !== false) {
            <button type="button"
                    class="w-9 h-9 rounded-lg bg-slate-50 border border-slate-200 flex items-center justify-center cursor-pointer transition-all hover:bg-slate-100 hover:border-slate-300 hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed"
                    [matMenuTriggerFor]="exportMenu"
                    [disabled]="isLoading() || filteredWorkers().length === 0"
                    title="Exportar datos">
              <mat-icon class="!text-slate-600 !text-lg">download</mat-icon>
            </button>

            <mat-menu #exportMenu="matMenu">
              <button mat-menu-item (click)="exportToCSV()">
                <mat-icon>table_chart</mat-icon>
                <span>Exportar a CSV</span>
              </button>
              <button mat-menu-item (click)="exportToJSON()">
                <mat-icon>code</mat-icon>
                <span>Exportar a JSON</span>
              </button>
            </mat-menu>
          }

          <!-- Botón de Empresas -->
          <button type="button"
                  class="w-9 h-9 rounded-lg bg-slate-50 border border-slate-200 flex items-center justify-center cursor-pointer transition-all hover:bg-slate-100 hover:border-slate-300 hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed"
                  (click)="openCompaniesDialog()"
                  title="Gestionar empresas">
            <mat-icon class="!text-slate-600 !text-lg">business</mat-icon>
          </button>

          @if (isAdmin()) {
            <button type="button"
                    class="w-9 h-9 rounded-lg bg-slate-50 border border-slate-200 flex items-center justify-center cursor-pointer transition-all hover:bg-slate-100 hover:border-slate-300 hover:-translate-y-0.5 disabled:opacity-50 disabled:cursor-not-allowed"
                    (click)="goToConfig()"
                    title="Configurar módulo">
              <mat-icon class="!text-slate-600 !text-lg">settings</mat-icon>
            </button>
          }

          <button type="button"
                  class="inline-flex items-center gap-1.5 px-4 py-2 bg-gradient-amber text-white border-none rounded-lg text-sm font-semibold cursor-pointer transition-all shadow-lg shadow-amber-500/30 hover:-translate-y-0.5 hover:shadow-xl hover:shadow-amber-500/40 disabled:opacity-60 disabled:cursor-not-allowed"
                  (click)="createWorker()"
                  [disabled]="isLoading()">
            <mat-icon class="!text-lg">add</mat-icon>
            Nuevo Trabajador
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- ============================================
       BÚSQUEDA Y FILTROS
       ============================================ -->
  @if (config()?.gridConfig?.enableSearch !== false || config()?.gridConfig?.enableFilters !== false || filterType() !== 'all' || filterCompanyName()) {
    <section class="bg-white rounded-2xl p-4 mb-5 border border-slate-200 shadow-sm">
      <div class="flex flex-wrap items-center gap-4">

        <!-- Search Box - Ancho dinámico según filtros -->
        @if (config()?.gridConfig?.enableSearch !== false) {
          <app-search-bar
            class="min-w-[300px] flex-1"
            [themeColor]="'amber'"
            [placeholder]="'Buscar trabajadores...'"
            (searchChange)="onSearch($event)">
          </app-search-bar>
        }

        <!-- Filtro por tipo de trabajador -->
        <div class="flex items-center gap-2">
          <button type="button"
                  class="h-10 px-3 text-sm font-medium rounded-lg border transition-all"
                  [class.bg-amber-500]="filterType() === 'all'"
                  [class.text-white]="filterType() === 'all'"
                  [class.border-amber-500]="filterType() === 'all'"
                  [class.bg-white]="filterType() !== 'all'"
                  [class.text-slate-600]="filterType() !== 'all'"
                  [class.border-slate-200]="filterType() !== 'all'"
                  [class.hover:bg-slate-50]="filterType() !== 'all'"
                  (click)="setFilterType('all')">
            Todos
          </button>
          <button type="button"
                  class="h-10 px-3 text-sm font-medium rounded-lg border transition-all flex items-center gap-1"
                  [class.bg-blue-500]="filterType() === 'internal'"
                  [class.text-white]="filterType() === 'internal'"
                  [class.border-blue-500]="filterType() === 'internal'"
                  [class.bg-white]="filterType() !== 'internal'"
                  [class.text-blue-600]="filterType() !== 'internal'"
                  [class.border-blue-200]="filterType() !== 'internal'"
                  [class.hover:bg-blue-50]="filterType() !== 'internal'"
                  (click)="setFilterType('internal')">
            <mat-icon class="!text-base">person</mat-icon>
            Propios
          </button>
          <button type="button"
                  class="h-10 px-3 text-sm font-medium rounded-lg border transition-all flex items-center gap-1"
                  [class.bg-purple-500]="filterType() === 'contractor'"
                  [class.text-white]="filterType() === 'contractor'"
                  [class.border-purple-500]="filterType() === 'contractor'"
                  [class.bg-white]="filterType() !== 'contractor'"
                  [class.text-purple-600]="filterType() !== 'contractor'"
                  [class.border-purple-200]="filterType() !== 'contractor'"
                  [class.hover:bg-purple-50]="filterType() !== 'contractor'"
                  (click)="setFilterType('contractor')">
            <mat-icon class="!text-base">groups</mat-icon>
            Subcontratados
          </button>
        </div>

        <!-- Filtro por empresa activo -->
        @if (filterCompanyName()) {
          <div class="inline-flex items-center gap-2 px-3 py-1.5 bg-gradient-to-r from-amber-100 to-amber-200 border-2 border-amber-400 rounded-full text-sm font-semibold text-amber-900">
            <mat-icon class="!text-base !text-amber-700">business</mat-icon>
            <span>{{ filterCompanyName() }}</span>
            <button type="button"
                    class="w-5 h-5 rounded-full bg-amber-700/20 hover:bg-red-600 hover:text-white flex items-center justify-center transition-all"
                    (click)="clearCompanyFilter()"
                    title="Quitar filtro">
              <mat-icon class="!text-xs">close</mat-icon>
            </button>
          </div>
        }

        <!-- Filtros dinámicos -->
        @if (config()?.gridConfig?.enableFilters !== false && filterableFields().length > 0) {
          @for (field of filterableFields(); track field.id) {
            <!-- Searchable Dropdown Filter (para todos los tipos) -->
          <div class="relative min-w-[200px]">
            <!-- Trigger Button -->
            <button
              type="button"
              (click)="toggleFilterDropdown(field.name, $event)"
              class="w-full h-10 pl-10 pr-8 border border-slate-200 rounded-lg text-sm bg-white hover:bg-slate-50 transition-all flex items-center justify-between text-left"
              [class.border-amber-500]="isFilterDropdownOpen(field.name)"
              [class.ring-2]="isFilterDropdownOpen(field.name)"
              [class.ring-amber-100]="isFilterDropdownOpen(field.name)">
              <mat-icon class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 !text-xl">filter_list</mat-icon>
              <span class="truncate text-slate-700">
                @if (customFieldFilters()[field.name]) {
                  <span class="font-medium">{{ getSelectedFilterLabel(field.name) }}</span>
                } @else {
                  <span class="text-slate-500">{{ field.label }}: Todos</span>
                }
              </span>
              <mat-icon class="!text-lg text-slate-400">
                {{ isFilterDropdownOpen(field.name) ? 'expand_less' : 'expand_more' }}
              </mat-icon>
            </button>

            <!-- Dropdown Menu -->
            @if (isFilterDropdownOpen(field.name)) {
              <!-- Overlay -->
              <div class="fixed inset-0 z-40" (click)="closeFilterDropdown()"></div>

              <!-- Dropdown Content -->
              <div class="absolute top-full left-0 mt-1 w-full min-w-[250px] bg-white rounded-lg shadow-lg border border-slate-200 z-50 max-h-[300px] flex flex-col">
                <!-- Search Input -->
                <div class="p-2 border-b border-slate-200">
                  <div class="relative">
                    <mat-icon class="absolute left-2 top-1/2 -translate-y-1/2 text-slate-400 !text-lg">search</mat-icon>
                    <input
                      type="text"
                      [value]="filterSearchTerms()[field.name] || ''"
                      (input)="onFilterSearchChange(field.name, $any($event.target).value)"
                      (click)="$event.stopPropagation()"
                      placeholder="Buscar..."
                      class="w-full h-8 pl-8 pr-3 border border-slate-200 rounded text-xs focus:border-amber-500 focus:ring-1 focus:ring-amber-100 outline-none"
                      autofocus>
                  </div>
                </div>

                <!-- Options List -->
                <div class="overflow-y-auto flex-1">
                  <!-- Opción "Todos" -->
                  <button
                    type="button"
                    (click)="selectFilterValue(field.name, null, $event)"
                    class="w-full px-3 py-2 text-left hover:bg-slate-50 transition-colors flex items-center justify-between text-sm"
                    [class.bg-amber-50]="!customFieldFilters()[field.name]"
                    [class.text-amber-700]="!customFieldFilters()[field.name]"
                    [class.font-medium]="!customFieldFilters()[field.name]">
                    <span>Todos</span>
                    @if (!customFieldFilters()[field.name]) {
                      <mat-icon class="!text-lg text-amber-600">check</mat-icon>
                    }
                  </button>

                  <!-- Opciones únicas -->
                  @for (option of filteredOptions()[field.name]; track option.value) {
                    <button
                      type="button"
                      (click)="selectFilterValue(field.name, option.value, $event)"
                      class="w-full px-3 py-2 text-left hover:bg-slate-50 transition-colors flex items-center justify-between text-sm group"
                      [class.bg-amber-50]="customFieldFilters()[field.name] === option.value"
                      [class.text-amber-700]="customFieldFilters()[field.name] === option.value"
                      [class.font-medium]="customFieldFilters()[field.name] === option.value">
                      <span class="truncate flex-1">{{ option.label }}</span>
                      <div class="flex items-center gap-2 ml-2">
                        <span class="text-xs px-1.5 py-0.5 bg-slate-100 text-slate-600 rounded group-hover:bg-slate-200">
                          {{ option.count }}
                        </span>
                        @if (customFieldFilters()[field.name] === option.value) {
                          <mat-icon class="!text-lg text-amber-600">check</mat-icon>
                        }
                      </div>
                    </button>
                  }

                  <!-- Sin resultados -->
                  @if (filteredOptions()[field.name]?.length === 0) {
                    <div class="px-3 py-4 text-center text-sm text-slate-500">
                      No se encontraron resultados
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        }

          <!-- Clear button -->
          @if (hasActiveFilters()) {
            <button
              type="button"
              (click)="clearAllFilters()"
              class="h-10 px-3 text-sm font-medium text-slate-600 hover:text-slate-900 hover:bg-slate-100 rounded-lg transition-colors flex items-center gap-2 border border-slate-200"
              title="Limpiar filtros">
              <mat-icon class="!text-lg">clear</mat-icon>
              <span>{{ activeFiltersCount() }}</span>
            </button>
          }
        }

      </div>
    </section>
  }

  <!-- ============================================
       BARRA DE ACCIONES MASIVAS
       ============================================ -->
  @if (config()?.gridConfig?.enableBulkActions !== false && selectedWorkers().size > 0) {
    <div class="bg-amber-50 border-2 border-amber-200 rounded-xl p-4 flex items-center justify-between mb-5 animate-fadeIn">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 bg-amber-500 rounded-lg flex items-center justify-center">
          <mat-icon class="!text-white !text-lg">check_circle</mat-icon>
        </div>
        <div>
          <p class="text-sm font-semibold text-amber-900">
            {{ selectedWorkers().size }} trabajador(es) seleccionado(s)
          </p>
          <p class="text-xs text-amber-700">
            Acciones disponibles para la selección
          </p>
        </div>
      </div>

      <div class="flex items-center gap-2">
        <button type="button"
                class="inline-flex items-center gap-1 px-3.5 py-2 bg-white text-slate-600 border border-slate-200 rounded-lg text-xs font-semibold cursor-pointer transition-all hover:bg-slate-50 hover:border-slate-300"
                (click)="clearSelection()">
          <mat-icon class="!text-base">close</mat-icon>
          Cancelar
        </button>
        <button type="button"
                class="inline-flex items-center gap-1 px-3.5 py-2 bg-gradient-red text-white border-none rounded-lg text-xs font-semibold cursor-pointer transition-all shadow-lg shadow-red-500/30 hover:-translate-y-0.5 hover:shadow-xl hover:shadow-red-500/40"
                (click)="deleteSelectedWorkers()">
          <mat-icon class="!text-base">delete</mat-icon>
          Eliminar
        </button>
      </div>
    </div>
  }

  <!-- ============================================
       TABLA DE TRABAJADORES
       ============================================ -->
  <div class="bg-white border border-slate-200 rounded-2xl overflow-hidden" [class.compact-mode]="config()?.gridConfig?.compactMode === true">
    <app-data-table
      [data]="paginatedWorkers"
      [config]="tableConfig()"
      [loading]="isLoading"
      [selectedIds]="selectedWorkers"
      [sortState]="currentSort"
      [customFieldsKey]="'customFields'"
      [idField]="'id'"
      (sortChange)="sortBy($event.field)"
      (selectionChange)="onSelectionChange($event)"
      (rowClick)="viewWorker($event)">

      <!-- Template para columna de tipo -->
      <ng-template #typeColumn let-row>
        @if (row.workerType === 'internal') {
          <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-[11px] font-semibold bg-blue-50 text-blue-700 border border-blue-200">
            <mat-icon class="!text-xs !w-3 !h-3">person</mat-icon>
            {{ getWorkerTypeLabel(row.workerType) }}
          </span>
        } @else {
          <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-[11px] font-semibold bg-purple-50 text-purple-700 border border-purple-200">
            <mat-icon class="!text-xs !w-3 !h-3">groups</mat-icon>
            {{ getWorkerTypeLabel(row.workerType) }}
          </span>
        }
      </ng-template>

      <!-- Template para columna de estado -->
      <ng-template #statusColumn let-row>
        @if (row.isActive) {
          <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-[11px] font-semibold bg-emerald-50 text-emerald-600">
            <mat-icon class="!text-xs !w-3 !h-3">check_circle</mat-icon>
            Activo
          </span>
        } @else {
          <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full text-[11px] font-semibold bg-slate-100 text-slate-600">
            <mat-icon class="!text-xs !w-3 !h-3">cancel</mat-icon>
            Inactivo
          </span>
        }
      </ng-template>

      <!-- Template para columna de acciones -->
      <ng-template #actionsColumn let-row>
        <button type="button"
                class="w-8 h-8 rounded-lg bg-transparent border-none flex items-center justify-center cursor-pointer transition-all hover:bg-slate-100"
                [matMenuTriggerFor]="actionsMenu"
                (click)="$event.stopPropagation()">
          <mat-icon class="!text-xl !text-slate-600">more_vert</mat-icon>
        </button>

        <mat-menu #actionsMenu="matMenu">
          <button mat-menu-item (click)="viewWorker(row)">
            <mat-icon>visibility</mat-icon>
            <span>Ver detalles</span>
          </button>
          <button mat-menu-item (click)="editWorker(row)">
            <mat-icon>edit</mat-icon>
            <span>Editar</span>
          </button>
          <button mat-menu-item (click)="toggleWorkerStatus(row)">
            <mat-icon>{{ row.isActive ? 'block' : 'check_circle' }}</mat-icon>
            <span>{{ row.isActive ? 'Desactivar' : 'Activar' }}</span>
          </button>
          <mat-divider></mat-divider>
          <button mat-menu-item (click)="deleteWorker(row)" class="text-red-600">
            <mat-icon class="text-red-600">delete</mat-icon>
            <span>Eliminar</span>
          </button>
        </mat-menu>
      </ng-template>
    </app-data-table>

    <!-- ============================================
         PAGINACIÓN
         ============================================ -->
    @if (filteredWorkers().length > 0) {
      <app-pagination
        [mode]="'client'"
        [currentPage]="currentPage()"
        [itemsPerPage]="itemsPerPage()"
        [totalPages]="totalPages()"
        [totalItems]="filteredWorkers().length"
        [pageSizeOptions]="pageSizeOptions"
        [themeColor]="'amber'"
        (pageChange)="goToPage($event)"
        (pageSizeChange)="changePageSize($event)">
      </app-pagination>
    }
  </div>
</div>
