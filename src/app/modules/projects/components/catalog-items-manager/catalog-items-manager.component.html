<!-- catalog-items-manager.component.html - Tailwind + Blue theme -->

<div class="flex flex-col w-full max-h-[90vh] bg-white rounded-2xl overflow-hidden animate-fadeIn">

  <!-- ========== HEADER ========== -->
  <div class="flex items-center justify-between px-5 py-4 bg-gradient-to-br from-blue-500 to-blue-600 text-white shrink-0">
    <div class="flex items-center gap-3">
      <div class="w-[42px] h-[42px] flex items-center justify-center bg-white/20 rounded-[10px] backdrop-blur-sm">
        <mat-icon class="text-white !text-[22px] !w-[22px] !h-[22px]">settings</mat-icon>
      </div>
      <div class="flex flex-col gap-0.5">
        <h2 class="m-0 text-[1.0625rem] font-bold leading-tight">Administrar Catálogo de Items</h2>
        <p class="m-0 text-xs font-normal opacity-90">Gestiona los items reutilizables para tus estimados</p>
      </div>
    </div>
    <button type="button" class="close-btn" (click)="close()" title="Cerrar (Esc)">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- ========== CONTENT ========== -->
  <div class="flex-1 overflow-y-auto p-4 bg-slate-50 flex flex-col gap-4">

    <!-- Formulario Crear/Editar -->
    <div class="bg-white border border-slate-200 rounded-xl p-4">
      <div class="flex items-center justify-between pb-3 mb-3 border-b border-slate-100">
        <div class="flex items-center gap-2 text-sm font-semibold text-slate-800">
          <mat-icon class="!text-[18px] !w-[18px] !h-[18px] text-blue-500">{{ isEditMode() ? 'edit' : 'add_circle' }}</mat-icon>
          <span>{{ isEditMode() ? 'Editar Item' : 'Agregar Nuevo Item' }}</span>
        </div>
        <button type="button"
                class="flex items-center gap-1.5 py-1 px-2.5 text-[0.6875rem] font-medium rounded-lg transition-all duration-200"
                [class]="showMaterialsPicker() ? 'bg-green-100 text-green-700 border border-green-300' : 'bg-slate-50 text-slate-600 border border-slate-200 hover:bg-green-50 hover:text-green-600 hover:border-green-200'"
                (click)="toggleMaterialsPicker()">
          <mat-icon class="!text-[14px] !w-[14px] !h-[14px]">{{ showMaterialsPicker() ? 'close' : 'inventory_2' }}</mat-icon>
          {{ showMaterialsPicker() ? 'Cerrar' : 'Importar desde Materiales' }}
        </button>
      </div>

      <form [formGroup]="itemForm" (ngSubmit)="saveItem()" class="space-y-3">
        <!-- Nombre -->
        <div class="flex flex-col gap-1">
          <label class="flex items-center gap-1 text-[0.6875rem] font-medium text-slate-600">
            <mat-icon class="!text-[14px] !w-[14px] !h-[14px] text-slate-400">label</mat-icon>
            Nombre del Item
            <span class="text-red-500 font-bold">*</span>
          </label>
          <input type="text"
                 formControlName="name"
                 placeholder="Ej: Instalación de piscina"
                 class="w-full py-2 px-3 text-[0.8125rem] text-slate-800 bg-white border-[1.5px] border-slate-200 rounded-lg outline-none transition-all duration-200 hover:border-slate-300 focus:border-blue-500 focus:ring-[3px] focus:ring-blue-500/10 placeholder:text-slate-400"
                 [class.!border-red-500]="itemForm.get('name')?.invalid && itemForm.get('name')?.touched"
                 [class.!bg-red-50]="itemForm.get('name')?.invalid && itemForm.get('name')?.touched">
          @if (itemForm.get('name')?.invalid && itemForm.get('name')?.touched) {
            <p class="flex items-center gap-1.5 m-0 py-1.5 px-2 text-[0.6875rem] font-medium text-red-600 bg-red-50 border-l-2 border-red-500 rounded">
              <mat-icon class="!text-[14px] !w-[14px] !h-[14px] text-red-500">error_outline</mat-icon>
              El nombre es requerido (mínimo 3 caracteres)
            </p>
          }
        </div>

        <!-- Descripción -->
        <div class="flex flex-col gap-1">
          <label class="flex items-center gap-1 text-[0.6875rem] font-medium text-slate-600">
            <mat-icon class="!text-[14px] !w-[14px] !h-[14px] text-slate-400">notes</mat-icon>
            Descripción
            <span class="font-normal text-slate-400">(Opcional)</span>
          </label>
          <textarea formControlName="description"
                    rows="2"
                    placeholder="Descripción detallada del item (opcional)..."
                    class="w-full py-2 px-3 text-[0.8125rem] text-slate-800 bg-white border-[1.5px] border-slate-200 rounded-lg outline-none resize-y min-h-[60px] font-[inherit] transition-all duration-200 hover:border-slate-300 focus:border-blue-500 focus:ring-[3px] focus:ring-blue-500/10 placeholder:text-slate-400"></textarea>
        </div>

        <!-- Botones -->
        <div class="flex gap-2 pt-3 border-t border-slate-100">
          @if (isEditMode()) {
            <button type="button" class="btn-cancel" (click)="resetForm()">
              <mat-icon>cancel</mat-icon>
              <span>Cancelar</span>
            </button>
          }
          <button type="submit" class="btn-primary" [disabled]="itemForm.invalid || isLoading()">
            <mat-icon>{{ isEditMode() ? 'save' : 'add_circle' }}</mat-icon>
            <span>{{ isEditMode() ? 'Actualizar' : 'Agregar' }}</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Panel Importar desde Materiales -->
    @if (showMaterialsPicker()) {
      <div class="bg-white border border-green-200 rounded-xl p-4 overflow-hidden">
        <div class="flex items-center justify-between pb-3 mb-3 border-b border-green-100">
          <div class="flex items-center gap-2 text-sm font-semibold text-green-700">
            <mat-icon class="!text-[18px] !w-[18px] !h-[18px] text-green-500">inventory_2</mat-icon>
            <span>Materiales Disponibles ({{ filteredMaterials().length }})</span>
          </div>

          <!-- Búsqueda materiales -->
          <div class="flex items-center gap-1.5 py-1.5 px-2.5 border border-green-200 rounded-lg bg-white min-w-[180px] focus-within:border-green-500 focus-within:shadow-[0_0_0_2px_rgba(16,185,129,0.1)] transition-all duration-200">
            <mat-icon class="!text-[16px] !w-[16px] !h-[16px] text-slate-400">search</mat-icon>
            <input type="text"
                   [value]="materialSearchTerm()"
                   (input)="onMaterialSearchChange($event)"
                   placeholder="Buscar materiales..."
                   class="flex-1 border-none outline-none text-xs text-slate-800 bg-transparent placeholder:text-slate-400">
          </div>
        </div>

        @if (materialsLoading()) {
          <div class="flex items-center justify-center py-6">
            <div class="w-6 h-6 border-2 border-slate-200 border-t-green-500 rounded-full animate-spin"></div>
            <span class="ml-2 text-xs text-slate-500">Cargando materiales...</span>
          </div>
        } @else if (filteredMaterials().length === 0) {
          <div class="flex flex-col items-center justify-center py-6 text-center">
            <mat-icon class="!text-[32px] !w-[32px] !h-[32px] text-slate-300 mb-2">check_circle</mat-icon>
            <p class="m-0 text-xs font-medium text-slate-500">
              {{ materialSearchTerm() ? 'No se encontraron materiales' : 'Todos los materiales ya fueron importados' }}
            </p>
          </div>
        } @else {
          <div class="max-h-[200px] overflow-y-auto space-y-1">
            @for (material of filteredMaterials(); track material.id) {
              <div class="flex items-center justify-between gap-2 py-2 px-3 rounded-lg border border-transparent hover:bg-green-50 hover:border-green-200 transition-all duration-200 cursor-pointer group"
                   (click)="importMaterial(material)">
                <div class="flex-1 min-w-0">
                  <p class="m-0 text-[0.8125rem] font-medium text-slate-700 overflow-hidden text-ellipsis whitespace-nowrap">{{ getMaterialName(material) }}</p>
                  @if (getMaterialDescription(material)) {
                    <p class="m-0 text-[0.6875rem] text-slate-400 overflow-hidden text-ellipsis whitespace-nowrap">{{ getMaterialDescription(material) }}</p>
                  }
                </div>
                <button type="button" class="btn-icon-sm opacity-0 group-hover:opacity-100 transition-opacity"
                        style="background: #ecfdf5; color: #10b981;" title="Agregar al catálogo">
                  <mat-icon>add_circle</mat-icon>
                </button>
              </div>
            }
          </div>
        }
      </div>
    }

    <!-- Lista de Items -->
    <div class="bg-white border border-slate-200 rounded-xl p-4 flex-1 flex flex-col min-h-0">
      <div class="flex items-center justify-between gap-4 pb-3 mb-3 border-b border-slate-100">
        <div class="flex items-center gap-2 text-sm font-semibold text-slate-800">
          <mat-icon class="!text-[18px] !w-[18px] !h-[18px] text-blue-500">inventory</mat-icon>
          <span>Items del Catálogo ({{ filteredItems.length }})</span>
        </div>

        <!-- Búsqueda -->
        <div class="flex items-center gap-1.5 py-1.5 px-2.5 border border-slate-200 rounded-lg bg-white min-w-[180px] focus-within:border-blue-500 focus-within:shadow-[0_0_0_2px_rgba(59,130,246,0.1)] transition-all duration-200">
          <mat-icon class="!text-[16px] !w-[16px] !h-[16px] text-slate-400">search</mat-icon>
          <input type="text"
                 [value]="searchTerm()"
                 (input)="onSearchChange($event)"
                 placeholder="Buscar items..."
                 class="flex-1 border-none outline-none text-xs text-slate-800 bg-transparent placeholder:text-slate-400">
        </div>
      </div>

      <!-- Items Grid -->
      @if (isLoading()) {
        <div class="flex flex-col items-center justify-center py-12">
          <div class="w-8 h-8 border-3 border-slate-200 border-t-blue-500 rounded-full animate-spin"></div>
          <p class="mt-3 text-[0.8125rem] text-slate-500">Cargando items...</p>
        </div>
      } @else if (filteredItems.length === 0) {
        <div class="flex flex-col items-center justify-center py-12 text-center">
          <mat-icon class="!text-[48px] !w-[48px] !h-[48px] text-slate-300 mb-3">inventory_2</mat-icon>
          <p class="m-0 text-sm font-semibold text-slate-500">No hay items en el catálogo</p>
          <p class="m-0 mt-1 text-xs text-slate-400">Agrega items usando el formulario de arriba</p>
        </div>
      } @else {
        <div class="grid grid-cols-[repeat(auto-fill,minmax(200px,1fr))] gap-3 overflow-y-auto flex-1 p-1">
          @for (item of filteredItems; track item.id) {
            <div class="flex items-start justify-between gap-2 p-3 bg-white border border-slate-200 rounded-[10px] transition-all duration-200 hover:border-blue-300 hover:shadow-[0_2px_8px_rgba(59,130,246,0.15)]">
              <div class="flex-1 min-w-0">
                <h4 class="m-0 text-[0.8125rem] font-semibold text-slate-800 overflow-hidden text-ellipsis whitespace-nowrap">{{ item.name }}</h4>
                @if (item.description) {
                  <p class="m-0 mt-1 text-[0.6875rem] text-slate-500 line-clamp-2 leading-snug">{{ item.description }}</p>
                }
              </div>
              <div class="flex gap-1 shrink-0">
                <button type="button" class="btn-icon-sm" (click)="editItem(item)" title="Editar"
                        style="background: #eff6ff; color: #3b82f6;">
                  <mat-icon>edit</mat-icon>
                </button>
                <button type="button" class="btn-icon-sm" (click)="deleteItem(item)" title="Eliminar"
                        style="background: #fef2f2; color: #ef4444;">
                  <mat-icon>delete</mat-icon>
                </button>
              </div>
            </div>
          }
        </div>
      }
    </div>

  </div>

  <!-- ========== FOOTER ========== -->
  <div class="flex justify-end px-4 py-3 bg-white border-t border-slate-200 shrink-0">
    <button type="button" class="btn-cancel" (click)="close()">
      <mat-icon>close</mat-icon>
      <span>Cerrar</span>
    </button>
  </div>

</div>
