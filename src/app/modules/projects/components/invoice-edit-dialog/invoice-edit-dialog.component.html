<!-- invoice-edit-dialog.component.html - Estilo Compacto Blue -->

<div class="dialog-container">

  <!-- Header -->
  <div class="dialog-header">
    <div class="header-content">
      <div class="icon-box">
        <mat-icon>receipt_long</mat-icon>
      </div>
      <div class="header-text">
        <h2 class="dialog-title">{{ 'projects.invoice.createInvoice' | translate }}</h2>
        <p class="dialog-subtitle">{{ 'projects.invoice.completeData' | translate }}</p>
      </div>
    </div>
    <button type="button" class="close-btn" (click)="cancel()" title="Cerrar">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Content -->
  <div class="dialog-content">

    <!-- Idioma y Fecha de Factura -->
    <div class="section section-primary">
      <div class="section-header">
        <mat-icon class="text-purple-500">description</mat-icon>
        <h3 class="section-title">{{ 'projects.invoice.invoiceInformation' | translate }}</h3>
        <span class="required-badge">{{ 'common.required' | translate }}</span>
      </div>
      <div class="form-grid cols-3">
        <div class="form-group">
          <label class="form-label">
            {{ 'projects.documentLanguage' | translate }} <span class="required">*</span>
          </label>
          <select
            [(ngModel)]="language"
            (ngModelChange)="onLanguageChange($event)"
            class="form-select">
            <option value="es">ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
            <option value="en">ðŸ‡ºðŸ‡¸ English</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">
            {{ 'projects.invoice.issueDate' | translate }} <span class="required">*</span>
          </label>
          <input
            type="date"
            [(ngModel)]="invoiceDate"
            required
            class="form-input"
            [placeholder]="'projects.invoice.selectDate' | translate">
        </div>
        <div class="form-group">
          <label class="form-label">
            {{ 'projects.directInvoice.customerName' | translate }}
          </label>
          <input
            type="text"
            [(ngModel)]="customerName"
            class="form-input"
            [placeholder]="'projects.directInvoice.customerNamePlaceholder' | translate">
        </div>
      </div>
    </div>

    <!-- Fechas y Tiempo de Trabajo -->
    <div class="section">
      <div class="section-header">
        <mat-icon class="text-purple-500">calendar_month</mat-icon>
        <h3 class="section-title">{{ 'projects.invoice.datesAndWorkTime' | translate }}</h3>
        <span class="required-badge">{{ 'common.required' | translate }}</span>
      </div>
      <div class="form-grid cols-3">
        <div class="form-group">
          <label class="form-label">
            {{ 'projects.invoice.startDate' | translate }} <span class="required">*</span>
          </label>
          <input
            type="date"
            [(ngModel)]="workStartDate"
            required
            class="form-input"
            [placeholder]="'projects.invoice.selectDate' | translate">
        </div>
        <div class="form-group">
          <label class="form-label">
            {{ 'projects.invoice.endDate' | translate }} <span class="required">*</span>
          </label>
          <input
            type="date"
            [(ngModel)]="workEndDate"
            required
            class="form-input"
            [placeholder]="'projects.invoice.selectDate' | translate">
        </div>
        <div class="form-group">
          <label class="form-label">
            {{ 'projects.invoice.hoursWorked' | translate }} <span class="required">*</span>
          </label>
          <div class="input-with-suffix">
            <input
              type="number"
              [(ngModel)]="workTime"
              min="0.5"
              step="0.5"
              required
              class="form-input"
              [placeholder]="'projects.invoice.exampleHours' | translate">
            <span class="input-suffix">{{ 'projects.invoice.hrs' | translate }}</span>
          </div>
        </div>
      </div>
    </div>

    <!-- CategorÃ­a de Markup (solo si estÃ¡ habilitado) - ANTES de materiales -->
    @if (markupEnabled() && markupCategories().length > 0) {
      <div class="section section-markup-subtle">
        <div class="form-group">
          <label class="form-label-small">
            <mat-icon class="label-icon">local_offer</mat-icon>
            Ajuste de precios
          </label>
          <select
            [(ngModel)]="selectedMarkupCategoryId"
            (ngModelChange)="onMarkupCategoryChange()"
            class="form-select-small">
            @for (category of markupCategories(); track category.id) {
              <option [value]="category.id">
                {{ category.name }} (+{{ category.percentage }}%)
              </option>
            }
          </select>
          <p class="helper-text">Los precios de materiales se ajustarÃ¡n segÃºn la categorÃ­a seleccionada</p>
        </div>
      </div>
    }

    <!-- Materiales Usados -->
    <div class="section">
      <div class="section-header">
        <mat-icon class="text-amber-500">inventory_2</mat-icon>
        <h3 class="section-title">{{ 'projects.invoice.materialsUsed' | translate }}</h3>
      </div>

      <!-- Dropdown con bÃºsqueda para agregar material -->
      <div class="add-item-row">
        <div class="material-search-container">
          <div class="search-input-wrapper">
            <mat-icon class="search-icon">search</mat-icon>
            <input
              type="text"
              class="search-input"
              [value]="materialSearchTerm()"
              (input)="onMaterialSearch($event)"
              (focus)="openMaterialDropdown()"
              placeholder="{{ 'projects.invoice.searchMaterial' | translate }}">
            @if (materialSearchTerm()) {
              <button type="button" class="clear-search-btn" (click)="closeMaterialDropdown()">
                <mat-icon>close</mat-icon>
              </button>
            }
          </div>
          @if (materialDropdownOpen()) {
            <div class="material-dropdown">
              @if (filteredMaterials().length > 0) {
                <div class="dropdown-list">
                  @for (material of filteredMaterials(); track material.id) {
                    <button
                      type="button"
                      class="dropdown-item"
                      (click)="selectMaterial(material.id!)">
                      <span class="material-name">{{ getMaterialName(material) }}</span>
                      <span class="material-price">{{ formatCurrency(getMaterialPrice(material)) }}</span>
                    </button>
                  }
                </div>
              } @else {
                <div class="dropdown-empty">
                  <span>{{ 'projects.invoice.noMaterialsFound' | translate }}</span>
                </div>
              }
            </div>
          }
        </div>
        <button type="button" class="btn-icon green" (click)="openAddMaterialDialog()"
                title="Crear nuevo material">
          <mat-icon>add</mat-icon>
        </button>
      </div>

      <!-- Lista de materiales seleccionados -->
      <div class="items-list">
        @for (material of selectedMaterials; track $index; let i = $index) {
          <div class="item-row">
            <div class="item-name">
              <mat-icon class="item-icon">category</mat-icon>
              <span>{{ material.materialName }}</span>
            </div>
            <div class="item-inputs">
              <div class="item-input-group">
                <label class="item-label">Cant.</label>
                <input
                  type="number"
                  [(ngModel)]="material.amount"
                  min="0"
                  step="1"
                  class="item-input"
                  placeholder="0">
              </div>
              <div class="item-input-group">
                <label class="item-label">P. Base</label>
                <div class="price-input-wrapper readonly">
                  <span class="price-symbol">$</span>
                  <input
                    type="number"
                    [value]="material.basePrice"
                    readonly
                    class="item-input price-input readonly"
                    placeholder="0.00">
                </div>
              </div>
              <div class="item-input-group">
                <label class="item-label">P. Final</label>
                <div class="price-input-wrapper">
                  <span class="price-symbol">$</span>
                  <input
                    type="number"
                    [(ngModel)]="material.price"
                    min="0"
                    step="0.01"
                    class="item-input price-input"
                    placeholder="0.00">
                </div>
              </div>
              <div class="item-input-group">
                <label class="item-label">Subtotal</label>
                <div class="price-display">
                  {{ formatCurrency(material.amount * material.price) }}
                </div>
              </div>
            </div>
            <button type="button" (click)="removeMaterial(i)" class="remove-btn">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        }
        @if (selectedMaterials.length === 0) {
          <div class="empty-state">
            <mat-icon>inventory_2</mat-icon>
            <p>{{ 'projects.invoice.noMaterialsAdded' | translate }}</p>
          </div>
        }
      </div>
    </div>

    <!-- Trabajadores -->
    <div class="section">
      <div class="section-header">
        <mat-icon class="text-green-500">engineering</mat-icon>
        <h3 class="section-title">{{ 'projects.invoice.workers' | translate }}</h3>
      </div>

      <!-- Dropdown con bÃºsqueda para agregar trabajador -->
      <div class="add-item-row">
        <div class="worker-search-container">
          <div class="search-input-wrapper">
            <mat-icon class="search-icon">search</mat-icon>
            <input
              type="text"
              class="search-input"
              [value]="workerSearchTerm()"
              (input)="onWorkerSearch($event)"
              (focus)="openWorkerDropdown()"
              placeholder="{{ 'projects.invoice.searchWorker' | translate }}">
            @if (workerSearchTerm()) {
              <button type="button" class="clear-search-btn" (click)="closeWorkerDropdown()">
                <mat-icon>close</mat-icon>
              </button>
            }
          </div>
          @if (workerDropdownOpen()) {
            <div class="worker-dropdown">
              @if (filteredWorkers().length > 0) {
                <div class="dropdown-list">
                  @for (worker of filteredWorkers(); track worker.id) {
                    <button
                      type="button"
                      class="dropdown-item"
                      (click)="selectWorker(worker.id!)">
                      <span class="worker-name">{{ getWorkerName(worker) }}</span>
                    </button>
                  }
                </div>
              } @else {
                <div class="dropdown-empty">
                  <span>{{ 'projects.invoice.noWorkersFound' | translate }}</span>
                </div>
              }
            </div>
          }
        </div>
      </div>

      <!-- Lista de trabajadores seleccionados -->
      <div class="items-list">
        @for (worker of selectedWorkers; track $index; let i = $index) {
          <div class="item-row worker-row">
            <div class="item-name">
              <mat-icon class="item-icon">person</mat-icon>
              <span>{{ worker.workerName }}</span>
            </div>
            <button type="button" (click)="removeWorker(i)" class="remove-btn">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        }
        @if (selectedWorkers.length === 0) {
          <div class="empty-state">
            <mat-icon>engineering</mat-icon>
            <p>{{ 'projects.invoice.noWorkersAdded' | translate }}</p>
          </div>
        }
      </div>
    </div>

    <!-- Notas y TÃ©rminos -->
    <div class="section">
      <div class="section-header">
        <mat-icon class="text-slate-500">notes</mat-icon>
        <h3 class="section-title">{{ 'projects.proposal.notes.title' | translate }}</h3>
      </div>
      <div class="form-grid cols-2">
        <div class="form-group">
          <label class="form-label">
            {{ 'projects.proposal.notes.clientNotes' | translate }}
          </label>
          <textarea
            [(ngModel)]="notes"
            rows="3"
            class="form-input"
            style="resize: vertical; min-height: 60px;"
            [placeholder]="'projects.proposal.notes.clientNotesPlaceholder' | translate"></textarea>
        </div>
        <div class="form-group">
          <label class="form-label flex items-center justify-between">
            <span>{{ 'projects.proposal.terms.title' | translate }}</span>
            <label class="flex items-center gap-1.5 cursor-pointer text-xs font-normal text-slate-500">
              <input
                type="checkbox"
                [(ngModel)]="showTermsInPrint"
                class="w-3.5 h-3.5 rounded border-slate-300 text-blue-600 focus:ring-blue-500 cursor-pointer">
              Mostrar en impresiÃ³n
            </label>
          </label>
          <textarea
            [(ngModel)]="terms"
            rows="3"
            class="form-input"
            style="resize: vertical; min-height: 60px;"
            [placeholder]="'projects.proposal.terms.placeholder' | translate"></textarea>
        </div>
      </div>
    </div>

    <!-- Resumen de Costos -->
    @if (selectedMaterials.length > 0) {
      <div class="section section-summary">
        <div class="section-header">
          <mat-icon class="text-blue-500">payments</mat-icon>
          <h3 class="section-title">{{ 'projects.invoice.costSummary' | translate }}</h3>
        </div>

        <!-- Tabla de materiales -->
        <div class="summary-table-wrapper">
          <table class="summary-table">
            <thead>
              <tr>
                <th class="text-left">{{ 'projects.invoice.material' | translate }}</th>
                <th class="text-center">{{ 'projects.invoice.qty' | translate }}</th>
                <th class="text-right">{{ 'projects.invoice.unitPrice' | translate }}</th>
                <th class="text-right">{{ 'projects.invoice.total' | translate }}</th>
              </tr>
            </thead>
            <tbody>
              @for (material of selectedMaterials; track $index) {
                <tr>
                  <td>{{ material.materialName }}</td>
                  <td class="text-center">{{ material.amount }}</td>
                  <td class="text-right">{{ formatCurrency(material.price) }}</td>
                  <td class="text-right font-semibold">{{ formatCurrency(material.amount * material.price) }}</td>
                </tr>
              }
            </tbody>
          </table>
        </div>

        <!-- Totales -->
        <div class="totals-section">
          <div class="total-row subtotal">
            <span class="total-label">{{ 'projects.invoice.estimateSubtotal' | translate }}:</span>
            <span class="total-value">{{ formatCurrency(getProposalSubtotal()) }}</span>
          </div>
          <div class="total-row materials">
            <span class="total-label">{{ 'projects.invoice.materialsSubtotal' | translate }}:</span>
            <span class="total-value">{{ formatCurrency(calculateMaterialsSubtotal()) }}</span>
          </div>
          <div class="total-row grand-total">
            <span class="total-label">{{ 'projects.invoice.grandTotal' | translate }}:</span>
            <span class="total-value">{{ formatCurrency(calculateGrandTotal()) }}</span>
          </div>
        </div>
      </div>
    }

  </div>

  <!-- Footer -->
  <div class="dialog-footer">
    <button
      type="button"
      (click)="cancel()"
      [disabled]="isSaving()"
      class="btn-cancel">
      <mat-icon>close</mat-icon>
      <span>{{ 'common.cancel' | translate }}</span>
    </button>
    <button
      type="button"
      (click)="save()"
      [disabled]="isSaving()"
      class="btn-primary">
      @if (isSaving()) {
        <span class="spinner-small"></span>
        <span>{{ 'common.saving' | translate }}...</span>
      } @else {
        <mat-icon>check</mat-icon>
        <span>{{ 'projects.invoice.createInvoice' | translate }}</span>
      }
    </button>
  </div>

</div>
