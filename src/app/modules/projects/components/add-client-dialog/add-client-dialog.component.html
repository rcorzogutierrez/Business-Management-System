<!-- add-client-dialog.component.html - Tailwind -->

<div class="flex flex-col h-full max-h-[85vh] min-w-[600px] max-w-[800px] bg-white rounded-xl overflow-hidden animate-fadeIn">

  <!-- Header -->
  <div class="flex items-center justify-between px-5 py-4 bg-gradient-to-br from-purple-600 to-purple-700 text-white shrink-0">
    <div class="flex items-center gap-3.5">
      <div class="w-[42px] h-[42px] flex items-center justify-center bg-white/20 rounded-[10px] backdrop-blur-sm">
        <mat-icon class="text-white !text-[22px] !w-[22px] !h-[22px]">person_add</mat-icon>
      </div>
      <div class="flex flex-col gap-0.5">
        <h2 class="m-0 text-[1.0625rem] font-bold leading-tight">Nuevo Cliente</h2>
        <p class="m-0 text-xs font-normal opacity-90">Complete los datos del cliente</p>
      </div>
    </div>
    <button type="button" (click)="cancel()" class="close-btn" title="Cerrar (Esc)">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Loading State -->
  @if (isLoading() && fields().length === 0) {
    <div class="flex flex-col items-center justify-center py-16 px-6 gap-4">
      <div class="w-10 h-10 border-3 border-slate-200 border-t-purple-500 rounded-full animate-spin"></div>
      <p class="m-0 text-sm font-medium text-slate-500">Cargando formulario...</p>
    </div>
  } @else {
    <!-- Form Container -->
    <div class="flex-1 overflow-y-auto overflow-x-hidden bg-white">
      <form [formGroup]="form" (ngSubmit)="save()" class="p-5">

        <!-- Grid de campos dinÃ¡micos -->
        <div class="grid grid-cols-2 gap-4">
          @for (field of fields(); track field.id) {
            <div [ngClass]="getFieldWidth(field)">

              <!-- TEXT / EMAIL / URL / PHONE -->
              @if (field.type === FieldType.TEXT || field.type === FieldType.EMAIL || field.type === FieldType.URL || field.type === FieldType.PHONE) {
                <div class="flex flex-col gap-1.5">
                  <label class="text-xs font-semibold text-gray-700 flex items-center gap-1">
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="text-red-500 font-bold text-[0.8125rem]">*</span>
                    }
                  </label>
                  <div class="relative flex items-center">
                    @if (field.icon) {
                      <mat-icon class="absolute left-2.5 !text-[18px] !w-[18px] !h-[18px] text-slate-400 pointer-events-none z-[1]">{{ field.icon }}</mat-icon>
                    }
                    <input
                      [type]="field.type === FieldType.EMAIL ? 'email' : field.type === FieldType.URL ? 'url' : 'text'"
                      [formControlName]="field.name"
                      [placeholder]="field.placeholder || field.label"
                      class="w-full py-2 px-3 text-[0.8125rem] text-slate-800 bg-white border-[1.5px] border-slate-200 rounded-lg outline-none transition-all duration-200 hover:border-slate-300 focus:border-purple-500 focus:ring-[3px] focus:ring-purple-500/10 placeholder:text-slate-400"
                      [class.pl-9]="field.icon"
                      [class.!border-red-500]="hasError(field.name)"
                      [class.!bg-red-50]="hasError(field.name)"
                      [attr.aria-label]="field.label">
                  </div>
                  @if (hasError(field.name)) {
                    <p class="flex items-center gap-1.5 m-0 py-1.5 px-2 text-[0.6875rem] font-medium text-red-600 bg-red-50 border-l-2 border-red-500 rounded">
                      <mat-icon class="!text-[14px] !w-[14px] !h-[14px] text-red-500">error_outline</mat-icon>
                      {{ getErrorMessage(field.name) }}
                    </p>
                  }
                  @if (field.helpText && !hasError(field.name)) {
                    <p class="m-0 text-[0.6875rem] text-slate-500 leading-snug">{{ field.helpText }}</p>
                  }
                </div>
              }

              <!-- TEXTAREA -->
              @if (field.type === FieldType.TEXTAREA) {
                <div class="flex flex-col gap-1.5">
                  <label class="text-xs font-semibold text-gray-700 flex items-center gap-1">
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="text-red-500 font-bold text-[0.8125rem]">*</span>
                    }
                  </label>
                  <textarea
                    [formControlName]="field.name"
                    [placeholder]="field.placeholder || field.label"
                    rows="3"
                    class="w-full py-2 px-3 text-[0.8125rem] text-slate-800 bg-white border-[1.5px] border-slate-200 rounded-lg outline-none resize-y min-h-[70px] transition-all duration-200 hover:border-slate-300 focus:border-purple-500 focus:ring-[3px] focus:ring-purple-500/10 placeholder:text-slate-400"
                    [class.!border-red-500]="hasError(field.name)"
                    [class.!bg-red-50]="hasError(field.name)"
                    [attr.aria-label]="field.label"></textarea>
                  @if (hasError(field.name)) {
                    <p class="flex items-center gap-1.5 m-0 py-1.5 px-2 text-[0.6875rem] font-medium text-red-600 bg-red-50 border-l-2 border-red-500 rounded">
                      <mat-icon class="!text-[14px] !w-[14px] !h-[14px] text-red-500">error_outline</mat-icon>
                      {{ getErrorMessage(field.name) }}
                    </p>
                  }
                  @if (field.helpText && !hasError(field.name)) {
                    <p class="m-0 text-[0.6875rem] text-slate-500 leading-snug">{{ field.helpText }}</p>
                  }
                </div>
              }

              <!-- NUMBER / CURRENCY -->
              @if (field.type === FieldType.NUMBER || field.type === FieldType.CURRENCY) {
                <div class="flex flex-col gap-1.5">
                  <label class="text-xs font-semibold text-gray-700 flex items-center gap-1">
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="text-red-500 font-bold text-[0.8125rem]">*</span>
                    }
                  </label>
                  <div class="relative flex items-center">
                    @if (field.type === FieldType.CURRENCY) {
                      <span class="absolute left-2.5 text-[0.8125rem] font-semibold text-slate-500 pointer-events-none z-[1]">$</span>
                    }
                    <input
                      type="number"
                      [formControlName]="field.name"
                      [placeholder]="field.placeholder || '0.00'"
                      [min]="field.validation.min ?? 0"
                      [max]="field.validation.max ?? null"
                      step="0.01"
                      class="w-full py-2 px-3 text-[0.8125rem] text-slate-800 bg-white border-[1.5px] border-slate-200 rounded-lg outline-none transition-all duration-200 hover:border-slate-300 focus:border-purple-500 focus:ring-[3px] focus:ring-purple-500/10 placeholder:text-slate-400"
                      [class.pl-6]="field.type === FieldType.CURRENCY"
                      [class.!border-red-500]="hasError(field.name)"
                      [class.!bg-red-50]="hasError(field.name)"
                      [attr.aria-label]="field.label">
                  </div>
                  @if (hasError(field.name)) {
                    <p class="flex items-center gap-1.5 m-0 py-1.5 px-2 text-[0.6875rem] font-medium text-red-600 bg-red-50 border-l-2 border-red-500 rounded">
                      <mat-icon class="!text-[14px] !w-[14px] !h-[14px] text-red-500">error_outline</mat-icon>
                      {{ getErrorMessage(field.name) }}
                    </p>
                  }
                </div>
              }

              <!-- DATE -->
              @if (field.type === FieldType.DATE) {
                <div class="flex flex-col gap-1.5">
                  <label class="text-xs font-semibold text-gray-700 flex items-center gap-1">
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="text-red-500 font-bold text-[0.8125rem]">*</span>
                    }
                  </label>
                  <div class="relative flex items-center">
                    <mat-icon class="absolute left-2.5 !text-[18px] !w-[18px] !h-[18px] text-slate-400 pointer-events-none z-[1]">event</mat-icon>
                    <input
                      type="date"
                      [formControlName]="field.name"
                      class="w-full py-2 pl-9 pr-3 text-[0.8125rem] text-slate-800 bg-white border-[1.5px] border-slate-200 rounded-lg outline-none transition-all duration-200 hover:border-slate-300 focus:border-purple-500 focus:ring-[3px] focus:ring-purple-500/10"
                      [class.!border-red-500]="hasError(field.name)"
                      [class.!bg-red-50]="hasError(field.name)"
                      [attr.aria-label]="field.label">
                  </div>
                  @if (hasError(field.name)) {
                    <p class="flex items-center gap-1.5 m-0 py-1.5 px-2 text-[0.6875rem] font-medium text-red-600 bg-red-50 border-l-2 border-red-500 rounded">
                      <mat-icon class="!text-[14px] !w-[14px] !h-[14px] text-red-500">error_outline</mat-icon>
                      {{ getErrorMessage(field.name) }}
                    </p>
                  }
                </div>
              }

              <!-- SELECT -->
              @if (field.type === FieldType.SELECT) {
                <div class="flex flex-col gap-1.5">
                  <label class="text-xs font-semibold text-gray-700 flex items-center gap-1">
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="text-red-500 font-bold text-[0.8125rem]">*</span>
                    }
                  </label>
                  <div class="relative flex items-center">
                    @if (field.icon) {
                      <mat-icon class="absolute left-2.5 !text-[18px] !w-[18px] !h-[18px] text-slate-400 pointer-events-none z-[1]">{{ field.icon }}</mat-icon>
                    }
                    <select
                      [formControlName]="field.name"
                      class="w-full py-2 pr-8 px-3 text-[0.8125rem] text-slate-800 bg-white border-[1.5px] border-slate-200 rounded-lg outline-none cursor-pointer appearance-none transition-all duration-200 hover:border-slate-300 focus:border-purple-500 focus:ring-[3px] focus:ring-purple-500/10"
                      [class.pl-9]="field.icon"
                      [class.!border-red-500]="hasError(field.name)"
                      [class.!bg-red-50]="hasError(field.name)"
                      [attr.aria-label]="field.label">
                      <option value="">Seleccionar...</option>
                      @for (option of field.options; track option.value) {
                        <option [value]="option.value">{{ option.label }}</option>
                      }
                    </select>
                    <mat-icon class="absolute right-2.5 !text-[20px] !w-[20px] !h-[20px] text-slate-400 pointer-events-none z-[1]">arrow_drop_down</mat-icon>
                  </div>
                  @if (hasError(field.name)) {
                    <p class="flex items-center gap-1.5 m-0 py-1.5 px-2 text-[0.6875rem] font-medium text-red-600 bg-red-50 border-l-2 border-red-500 rounded">
                      <mat-icon class="!text-[14px] !w-[14px] !h-[14px] text-red-500">error_outline</mat-icon>
                      {{ getErrorMessage(field.name) }}
                    </p>
                  }
                </div>
              }

              <!-- CHECKBOX -->
              @if (field.type === FieldType.CHECKBOX) {
                <div class="flex items-start py-2.5">
                  <label class="flex items-center gap-2.5 cursor-pointer select-none">
                    <input
                      type="checkbox"
                      [id]="field.name"
                      [formControlName]="field.name"
                      class="w-4 h-4 cursor-pointer accent-purple-600 rounded">
                    <span class="text-[0.8125rem] font-medium text-gray-700">{{ field.label }}</span>
                  </label>
                </div>
              }

              <!-- MULTISELECT -->
              @if (field.type === FieldType.MULTISELECT) {
                <div class="flex flex-col gap-1.5">
                  <label class="text-xs font-semibold text-gray-700 flex items-center gap-1">
                    {{ field.label }}
                    @if (field.validation.required) {
                      <span class="text-red-500 font-bold text-[0.8125rem]">*</span>
                    }
                  </label>
                  <div class="flex flex-col gap-2 p-3 bg-slate-50 border-[1.5px] border-slate-200 rounded-lg">
                    @for (option of field.options; track option.value) {
                      <label class="flex items-center gap-2.5 p-2 bg-white rounded-md cursor-pointer transition-all duration-200 hover:bg-purple-50">
                        <input
                          type="checkbox"
                          [id]="field.name + '_' + option.value"
                          [value]="option.value"
                          class="w-4 h-4 cursor-pointer accent-purple-600 rounded">
                        <span class="text-[0.8125rem] font-medium text-gray-700">{{ option.label }}</span>
                      </label>
                    }
                  </div>
                  @if (hasError(field.name)) {
                    <p class="flex items-center gap-1.5 m-0 py-1.5 px-2 text-[0.6875rem] font-medium text-red-600 bg-red-50 border-l-2 border-red-500 rounded">
                      <mat-icon class="!text-[14px] !w-[14px] !h-[14px] text-red-500">error_outline</mat-icon>
                      {{ getErrorMessage(field.name) }}
                    </p>
                  }
                </div>
              }

              <!-- DICTIONARY -->
              @if (field.type === FieldType.DICTIONARY && field.options && field.options.length > 0) {
                <div class="col-span-2 flex flex-col gap-3">
                  <div class="flex flex-col gap-1">
                    <label class="text-xs font-semibold text-gray-700">{{ field.label }}</label>
                    @if (field.helpText) {
                      <p class="m-0 text-[0.6875rem] text-slate-500 leading-snug">{{ field.helpText }}</p>
                    }
                  </div>
                  <div class="grid grid-cols-2 gap-3.5 p-3.5 bg-slate-50 border-[1.5px] border-slate-200 rounded-lg">
                    @for (option of field.options; track option.value) {
                      <div class="flex flex-col gap-1.5">
                        <label class="text-[0.6875rem] font-semibold text-slate-500 uppercase tracking-wide">{{ option.label }}</label>
                        <input
                          type="text"
                          [formControlName]="field.name + '_' + option.value"
                          [placeholder]="option.label"
                          class="py-2 px-3 text-[0.8125rem] text-slate-800 bg-white border-[1.5px] border-slate-200 rounded-md outline-none transition-all duration-200 hover:border-slate-300 focus:border-purple-500 focus:ring-[3px] focus:ring-purple-500/10 placeholder:text-slate-400"
                          [attr.aria-label]="option.label">
                      </div>
                    }
                  </div>
                </div>
              }

            </div>
          }
        </div>

      </form>
    </div>

    <!-- Footer -->
    <div class="flex items-center justify-end gap-3 px-5 py-4 bg-slate-50 border-t border-slate-200 shrink-0">
      <button
        type="button"
        (click)="cancel()"
        [disabled]="isLoading()"
        class="btn-cancel">
        <mat-icon>close</mat-icon>
        <span>Cancelar</span>
      </button>
      <button
        type="button"
        (click)="save()"
        [disabled]="isLoading() || form.invalid"
        class="btn-primary">
        @if (isLoading()) {
          <span class="btn-spinner"></span>
        } @else {
          <mat-icon>check</mat-icon>
        }
        <span>{{ isLoading() ? 'Guardando...' : 'Guardar Cliente' }}</span>
      </button>
    </div>
  }

</div>
