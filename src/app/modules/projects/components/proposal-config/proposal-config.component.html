<!-- proposal-config.component.html - DISEÑO COMPACTO -->

<div class="config-container">

  <!-- ========== HEADER - Usando ModuleHeaderComponent ========== -->
  <app-module-header
    icon="settings"
    title="Configuración de Estimados"
    subtitle="Mapeo de campos y valores por defecto"
    moduleColor="blue"
    [showBackButton]="true"
    backButtonTooltip="Volver a proyectos"
    (backAction)="goBack()">
  </app-module-header>

  <!-- ========== INFO BOX ========== -->
  <div class="info-box animate-fadeIn" style="animation-delay: 0.05s">
    <mat-icon>lightbulb</mat-icon>
    <div>
      <h3>¿Cómo funciona?</h3>
      <p>Cuando actives "Usar misma dirección del cliente" en el formulario de estimados, el sistema copiará automáticamente los datos usando este mapeo.</p>
    </div>
  </div>

  <form [formGroup]="configForm" class="space-y-5">

    <!-- ========== CAMPOS BÁSICOS DEL CLIENTE ========== -->
    <div class="config-section animate-fadeIn" style="animation-delay: 0.1s">
      <div class="section-header">
        <mat-icon class="text-blue-500">person</mat-icon>
        <div>
          <h2>Campos Básicos del Cliente</h2>
          <p>Mapea los campos del Cliente con los del Estimado</p>
        </div>
      </div>

      <div class="mapping-grid">
        @for (mapping of basicFieldMappings; track mapping.formControlName) {
          <div class="mapping-row">
            <div class="mapping-source">
              <mat-icon class="field-icon">{{ mapping.icon }}</mat-icon>
              <select [formControlName]="mapping.formControlName" required class="mapping-select">
                @for (field of availableFields(); track field.name) {
                  <option [value]="field.name">{{ field.label }}</option>
                }
              </select>
            </div>
            <div class="mapping-arrow">
              <mat-icon>arrow_forward</mat-icon>
            </div>
            <div class="mapping-target">
              <mat-icon>{{ mapping.destinationIcon || mapping.icon }}</mat-icon>
              <span>{{ mapping.label }}</span>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- ========== CAMPOS DE DIRECCIÓN ========== -->
    <div class="config-section animate-fadeIn" style="animation-delay: 0.15s">
      <div class="section-header">
        <mat-icon class="text-purple-500">location_on</mat-icon>
        <div>
          <h2>Campos de Dirección</h2>
          <p>Mapea los campos de dirección del Cliente con los del Estimado</p>
        </div>
      </div>

      <div class="mapping-grid">
        @for (mapping of addressFieldMappings; track mapping.formControlName) {
          <div class="mapping-row">
            <div class="mapping-source">
              <mat-icon class="field-icon">{{ mapping.icon }}</mat-icon>
              <select [formControlName]="mapping.formControlName" required class="mapping-select">
                @for (field of availableFields(); track field.name) {
                  <option [value]="field.name">{{ field.label }}</option>
                }
              </select>
            </div>
            <div class="mapping-arrow">
              <mat-icon>arrow_forward</mat-icon>
            </div>
            <div class="mapping-target">
              <mat-icon>{{ mapping.destinationIcon || mapping.icon }}</mat-icon>
              <span>{{ mapping.label }}</span>
              @if (mapping.badge) {
                <span class="field-badge">{{ mapping.badge }}</span>
              }
            </div>
          </div>
        }
      </div>
    </div>

    <!-- ========== VALORES POR DEFECTO ========== -->
    <div class="config-section animate-fadeIn" style="animation-delay: 0.2s">
      <div class="section-header">
        <mat-icon class="text-amber-500">tune</mat-icon>
        <div>
          <h2>Valores Por Defecto</h2>
          <p>Define valores predeterminados para nuevos estimados</p>
        </div>
      </div>

      <div class="defaults-grid">
        <!-- Impuesto por defecto -->
        <div class="form-group">
          <label class="form-label">
            <mat-icon>percent</mat-icon>
            Impuesto por Defecto (%)
          </label>
          <input
            type="number"
            formControlName="defaultTaxPercentage"
            min="0"
            max="100"
            step="0.01"
            class="form-input"
            placeholder="0">
        </div>

        <!-- Días de validez -->
        <div class="form-group">
          <label class="form-label">
            <mat-icon>event</mat-icon>
            Validez por Defecto (días)
          </label>
          <input
            type="number"
            formControlName="defaultValidityDays"
            min="1"
            step="1"
            class="form-input"
            placeholder="30">
        </div>

        <!-- Tipo de trabajo -->
        <div class="form-group">
          <label class="form-label">
            <mat-icon>business</mat-icon>
            Tipo de Trabajo por Defecto
          </label>
          <select formControlName="defaultWorkType" class="form-input">
            <option value="residential">Residencial</option>
            <option value="commercial">Comercial</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ========== CLASIFICACIÓN DE SERVICIOS ========== -->
    <div class="config-section animate-fadeIn" style="animation-delay: 0.225s">
      <div class="section-header">
        <mat-icon class="text-blue-500">handyman</mat-icon>
        <div>
          <h2>Clasificación de Servicios</h2>
          <p>Opciones disponibles en estimados y facturas</p>
        </div>
        <button
          type="button"
          class="ml-auto flex items-center gap-1 text-sm text-blue-600 hover:text-blue-700 font-medium px-3 py-1.5 rounded-lg hover:bg-blue-50 transition-colors"
          (click)="addJobCategory()">
          <mat-icon class="!text-[18px] !w-[18px] !h-[18px]">add</mat-icon>
          Agregar
        </button>
      </div>

      <div class="flex flex-wrap gap-2">
        @for (category of jobCategories(); track category.id) {
          <div class="group flex items-center gap-1.5 rounded-lg border px-2.5 py-1.5 text-sm transition-all"
               [class]="category.isActive
                 ? 'bg-white border-slate-200 hover:border-blue-300'
                 : 'bg-slate-50 border-slate-200 opacity-50'">
            <button
              type="button"
              (click)="toggleJobCategoryActive(category.id)"
              [matTooltip]="category.isActive ? 'Desactivar' : 'Activar'"
              class="flex-shrink-0 w-4 h-4 rounded border transition-all"
              [class]="category.isActive
                ? 'bg-blue-600 border-blue-600 text-white'
                : 'bg-white border-slate-300'">
              @if (category.isActive) {
                <svg class="w-3 h-3 mx-auto" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/>
                </svg>
              }
            </button>
            <input
              type="text"
              [value]="category.label"
              (input)="updateJobCategoryLabel(category.id, $any($event.target).value)"
              class="bg-transparent border-none outline-none text-sm text-slate-700 w-[140px] placeholder:text-slate-400"
              placeholder="Nombre...">
            <button
              type="button"
              class="flex-shrink-0 text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"
              (click)="deleteJobCategory(category.id)"
              matTooltip="Eliminar">
              <mat-icon class="!text-[16px] !w-[16px] !h-[16px]">close</mat-icon>
            </button>
          </div>
        }

        @if (jobCategories().length === 0) {
          <p class="text-sm text-slate-400 italic">Sin clasificaciones. Haz clic en "Agregar".</p>
        }
      </div>
    </div>

    <!-- ========== MARKUP DE MATERIALES ========== -->
    <div class="config-section animate-fadeIn" style="animation-delay: 0.225s">
      <div class="section-header">
        <mat-icon class="text-orange-500">trending_up</mat-icon>
        <div class="flex-1">
          <h2>Markup de Materiales</h2>
          <p>Porcentaje de markup aplicado al costo de materiales en facturas</p>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium" [class.text-blue-600]="markupEnabled()" [class.text-slate-600]="!markupEnabled()">
            {{ markupEnabled() ? 'Habilitado' : 'Deshabilitado' }}
          </span>
          <button
            type="button"
            (click)="toggleMarkupEnabled()"
            role="switch"
            [attr.aria-checked]="markupEnabled()"
            class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            [class.bg-blue-600]="markupEnabled()"
            [class.bg-slate-300]="!markupEnabled()">
            <span
              class="inline-block h-4 w-4 transform rounded-full bg-white shadow transition-transform"
              [class.translate-x-6]="markupEnabled()"
              [class.translate-x-1]="!markupEnabled()">
            </span>
          </button>
        </div>
      </div>

      @if (markupEnabled()) {
        <div class="flex flex-wrap gap-2 mt-1">
          @for (category of markupCategories(); track category.id) {
            <div class="group flex items-center gap-1.5 rounded-lg border px-2.5 py-1.5 text-sm transition-all"
                 [class]="category.isActive
                   ? 'bg-orange-50 border-orange-200 hover:border-orange-400'
                   : 'bg-white border-slate-200 hover:border-slate-300'">
              <!-- Radio por defecto -->
              <button
                type="button"
                (click)="toggleCategoryActive(category.id)"
                [matTooltip]="'Categoría por defecto'"
                class="flex-shrink-0 w-4 h-4 rounded-full border-2 transition-all"
                [class]="category.isActive
                  ? 'border-orange-500 bg-orange-500'
                  : 'border-slate-300 bg-white'">
                @if (category.isActive) {
                  <svg class="w-2.5 h-2.5 mx-auto text-white" fill="currentColor" viewBox="0 0 16 16">
                    <circle cx="8" cy="8" r="4"/>
                  </svg>
                }
              </button>
              <!-- Nombre -->
              <input
                type="text"
                [value]="category.name"
                (input)="updateCategoryName(category.id, $any($event.target).value)"
                class="bg-transparent border-none outline-none text-sm text-slate-700 w-[80px] placeholder:text-slate-400"
                placeholder="Nombre">
              <!-- Porcentaje -->
              <div class="flex items-center gap-0.5 border-l border-slate-200 pl-1.5">
                <input
                  type="number"
                  [value]="category.percentage"
                  (input)="updateCategoryPercentage(category.id, +$any($event.target).value)"
                  min="0" max="100" step="0.1"
                  class="bg-transparent border-none outline-none text-sm text-slate-700 w-[40px] text-right placeholder:text-slate-400"
                  placeholder="0">
                <span class="text-slate-400 text-xs">%</span>
              </div>
              <!-- Eliminar -->
              <button
                type="button"
                class="flex-shrink-0 text-slate-300 hover:text-red-500 transition-colors opacity-0 group-hover:opacity-100"
                (click)="deleteMarkupCategory(category.id)"
                matTooltip="Eliminar">
                <mat-icon class="!text-[16px] !w-[16px] !h-[16px]">close</mat-icon>
              </button>
            </div>
          }

          @if (markupCategories().length === 0) {
            <p class="text-sm text-slate-400 italic">Sin categorías. Haz clic en "Agregar".</p>
          }
        </div>

        <button
          type="button"
          class="mt-2 flex items-center gap-1 text-sm text-orange-600 hover:text-orange-700 font-medium px-3 py-1.5 rounded-lg hover:bg-orange-50 transition-colors"
          (click)="addMarkupCategory()">
          <mat-icon class="!text-[18px] !w-[18px] !h-[18px]">add</mat-icon>
          Agregar Categoría
        </button>
      }
    </div>

    <!-- ========== CONFIGURACIÓN DE LA TABLA - Usando componente compartido ========== -->
    @if (!isLoading && gridConfig()) {
      <app-grid-config-section
        [gridConfig]="gridConfig()"
        moduleColor="blue"
        entityLabel="estimados"
        [pageSizeOptions]="pageSizeOptions"
        [itemsPerPage]="itemsPerPageSignal()"
        [isLoading]="isLoading"
        [allFeaturesEnabled]="allFeaturesEnabled()"
        (configChange)="onConfigChange($event)"
        (toggleAll)="toggleAllFeatures()"
      />
    }

    <!-- ========== TÉRMINOS Y CONDICIONES ========== -->
    <div class="config-section animate-fadeIn" style="animation-delay: 0.3s">
      <div class="section-header">
        <mat-icon class="text-green-500">description</mat-icon>
        <div>
          <h2>Términos y Condiciones</h2>
          <p>Este texto aparecerá automáticamente en todos los nuevos estimados</p>
        </div>
      </div>

      <div class="form-group">
        <textarea
          formControlName="defaultTerms"
          rows="10"
          class="form-textarea"
          placeholder="Ingresa los términos y condiciones por defecto..."></textarea>
      </div>
    </div>

    <!-- ========== BOTONES DE ACCIÓN ========== -->
    <div class="actions-bar animate-fadeIn" style="animation-delay: 0.35s">
      <div class="flex gap-2">
        <button type="button" class="btn-cancel" (click)="goBack()" [disabled]="isSaving()">
          <mat-icon>close</mat-icon>
          <span>Cancelar</span>
        </button>
        <button type="button" class="btn-secondary" (click)="resetToDefaults()" [disabled]="isSaving()">
          <mat-icon>refresh</mat-icon>
          <span>Restablecer</span>
        </button>
      </div>

      <button type="button" class="btn-save" (click)="saveConfig()" [disabled]="isSaving() || configForm.invalid">
        @if (isSaving()) {
          <div class="btn-spinner"></div>
        } @else {
          <mat-icon>save</mat-icon>
        }
        <span>Guardar Configuración</span>
      </button>
    </div>

  </form>

</div>
