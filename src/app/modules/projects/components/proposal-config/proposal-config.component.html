<!-- proposal-config.component.html - DISEÑO COMPACTO -->

<div class="config-container">

  <!-- ========== HEADER COMPACTO ========== -->
  <header class="bg-white rounded-2xl border border-slate-200 shadow-sm p-4 mb-5 animate-fadeIn">
    <div class="flex items-center gap-4">
      <button type="button" class="back-btn" (click)="goBack()" title="Volver">
        <mat-icon>arrow_back</mat-icon>
      </button>
      <div class="header-icon-box blue">
        <mat-icon>settings</mat-icon>
      </div>
      <div>
        <h1 class="text-lg font-bold text-slate-800">Configuración de Estimados</h1>
        <p class="text-xs text-slate-500">Mapeo de campos y valores por defecto</p>
      </div>
    </div>
  </header>

  <!-- ========== INFO BOX ========== -->
  <div class="info-box animate-fadeIn" style="animation-delay: 0.05s">
    <mat-icon>lightbulb</mat-icon>
    <div>
      <h3>¿Cómo funciona?</h3>
      <p>Cuando actives "Usar misma dirección del cliente" en el formulario de estimados, el sistema copiará automáticamente los datos usando este mapeo.</p>
    </div>
  </div>

  <form [formGroup]="configForm" class="space-y-5">

    <!-- ========== CAMPOS BÁSICOS DEL CLIENTE ========== -->
    <div class="config-section animate-fadeIn" style="animation-delay: 0.1s">
      <div class="section-header">
        <div class="section-icon blue">
          <mat-icon>person</mat-icon>
        </div>
        <div>
          <h2>Campos Básicos del Cliente</h2>
          <p>Mapea los campos del Cliente con los del Estimado</p>
        </div>
      </div>

      <div class="mapping-grid">
        @for (mapping of basicFieldMappings; track mapping.formControlName) {
          <div class="mapping-row">
            <div class="mapping-source">
              <mat-icon class="field-icon">{{ mapping.icon }}</mat-icon>
              <select [formControlName]="mapping.formControlName" required class="mapping-select">
                @for (field of availableFields(); track field.name) {
                  <option [value]="field.name">{{ field.label }}</option>
                }
              </select>
            </div>
            <div class="mapping-arrow">
              <mat-icon>arrow_forward</mat-icon>
            </div>
            <div class="mapping-target">
              <mat-icon>{{ mapping.destinationIcon || mapping.icon }}</mat-icon>
              <span>{{ mapping.label }}</span>
            </div>
          </div>
        }
      </div>
    </div>

    <!-- ========== CAMPOS DE DIRECCIÓN ========== -->
    <div class="config-section animate-fadeIn" style="animation-delay: 0.15s">
      <div class="section-header">
        <div class="section-icon purple">
          <mat-icon>location_on</mat-icon>
        </div>
        <div>
          <h2>Campos de Dirección</h2>
          <p>Mapea los campos de dirección del Cliente con los del Estimado</p>
        </div>
      </div>

      <div class="mapping-grid">
        @for (mapping of addressFieldMappings; track mapping.formControlName) {
          <div class="mapping-row">
            <div class="mapping-source">
              <mat-icon class="field-icon">{{ mapping.icon }}</mat-icon>
              <select [formControlName]="mapping.formControlName" required class="mapping-select">
                @for (field of availableFields(); track field.name) {
                  <option [value]="field.name">{{ field.label }}</option>
                }
              </select>
            </div>
            <div class="mapping-arrow">
              <mat-icon>arrow_forward</mat-icon>
            </div>
            <div class="mapping-target">
              <mat-icon>{{ mapping.destinationIcon || mapping.icon }}</mat-icon>
              <span>{{ mapping.label }}</span>
              @if (mapping.badge) {
                <span class="field-badge">{{ mapping.badge }}</span>
              }
            </div>
          </div>
        }
      </div>
    </div>

    <!-- ========== VALORES POR DEFECTO ========== -->
    <div class="config-section animate-fadeIn" style="animation-delay: 0.2s">
      <div class="section-header">
        <div class="section-icon amber">
          <mat-icon>tune</mat-icon>
        </div>
        <div>
          <h2>Valores Por Defecto</h2>
          <p>Define valores predeterminados para nuevos estimados</p>
        </div>
      </div>

      <div class="defaults-grid">
        <!-- Impuesto por defecto -->
        <div class="form-group">
          <label class="form-label">
            <mat-icon>percent</mat-icon>
            Impuesto por Defecto (%)
          </label>
          <input
            type="number"
            formControlName="defaultTaxPercentage"
            min="0"
            max="100"
            step="0.01"
            class="form-input"
            placeholder="0">
        </div>

        <!-- Días de validez -->
        <div class="form-group">
          <label class="form-label">
            <mat-icon>event</mat-icon>
            Validez por Defecto (días)
          </label>
          <input
            type="number"
            formControlName="defaultValidityDays"
            min="1"
            step="1"
            class="form-input"
            placeholder="30">
        </div>

        <!-- Tipo de trabajo -->
        <div class="form-group">
          <label class="form-label">
            <mat-icon>business</mat-icon>
            Tipo de Trabajo por Defecto
          </label>
          <select formControlName="defaultWorkType" class="form-input">
            <option value="residential">Residencial</option>
            <option value="commercial">Comercial</option>
          </select>
        </div>
      </div>
    </div>

    <!-- ========== MARKUP DE MATERIALES ========== -->
    <div class="config-section animate-fadeIn" style="animation-delay: 0.225s">
      <div class="section-header">
        <div class="section-icon orange">
          <mat-icon>trending_up</mat-icon>
        </div>
        <div class="flex-1">
          <h2>Categorías de Markup de Materiales</h2>
          <p>Sistema de markup por categorías para el costo de materiales en facturas</p>
        </div>
        <div class="flex items-center gap-2">
          <span class="text-sm font-medium" [class.text-blue-600]="markupEnabled()" [class.text-slate-600]="!markupEnabled()">
            {{ markupEnabled() ? 'Habilitado' : 'Deshabilitado' }}
          </span>
          <button
            type="button"
            (click)="toggleMarkupEnabled()"
            role="switch"
            [attr.aria-checked]="markupEnabled()"
            class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
            [class.bg-blue-600]="markupEnabled()"
            [class.bg-slate-300]="!markupEnabled()">
            <span
              class="inline-block h-4 w-4 transform rounded-full bg-white shadow transition-transform"
              [class.translate-x-6]="markupEnabled()"
              [class.translate-x-1]="!markupEnabled()">
            </span>
          </button>
        </div>
      </div>

      @if (markupEnabled()) {
        <div class="markup-config-content">
          <!-- Info Box -->
          <div class="info-box-small mb-4">
            <mat-icon>info</mat-icon>
            <p>Al convertir un estimado a factura, se podrá seleccionar una categoría para aplicar un porcentaje de markup al costo de los materiales.</p>
          </div>

          <!-- Lista de Categorías -->
          <div class="categories-list">
            @for (category of markupCategories(); track category.id) {
              <div class="category-item" [class.active]="category.isActive">
                <div class="category-content">
                  <!-- Radio button para seleccionar por defecto -->
                  <button
                    type="button"
                    (click)="toggleCategoryActive(category.id)"
                    [matTooltip]="'Categoría por defecto'"
                    class="flex-shrink-0 w-5 h-5 rounded-full border-2 transition-all focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                    [class.border-blue-600]="category.isActive"
                    [class.bg-blue-600]="category.isActive"
                    [class.border-slate-300]="!category.isActive">
                    @if (category.isActive) {
                      <svg class="w-3 h-3 mx-auto text-white" fill="currentColor" viewBox="0 0 16 16">
                        <circle cx="8" cy="8" r="3"/>
                      </svg>
                    }
                  </button>

                  <!-- Nombre de la categoría -->
                  <div class="category-field">
                    <label>Nombre</label>
                    <input
                      type="text"
                      [value]="category.name"
                      (input)="updateCategoryName(category.id, $any($event.target).value)"
                      class="category-input"
                      placeholder="Ej: Oro, Plata, Bronce">
                  </div>

                  <!-- Porcentaje -->
                  <div class="category-field percentage">
                    <label>Markup (%)</label>
                    <input
                      type="number"
                      [value]="category.percentage"
                      (input)="updateCategoryPercentage(category.id, +$any($event.target).value)"
                      min="0"
                      max="100"
                      step="0.1"
                      class="category-input"
                      placeholder="15">
                  </div>

                  <!-- Botón eliminar -->
                  <button
                    type="button"
                    class="delete-category-btn"
                    (click)="deleteMarkupCategory(category.id)"
                    matTooltip="Eliminar categoría">
                    <mat-icon>delete</mat-icon>
                  </button>
                </div>

                @if (category.isActive) {
                  <div class="default-badge">
                    <mat-icon>check_circle</mat-icon>
                    <span>Por defecto</span>
                  </div>
                }
              </div>
            }

            @if (markupCategories().length === 0) {
              <div class="empty-state">
                <mat-icon>category</mat-icon>
                <p>No hay categorías configuradas</p>
                <small>Haz clic en "Agregar Categoría" para comenzar</small>
              </div>
            }
          </div>

          <!-- Botón agregar categoría -->
          <button
            type="button"
            class="btn-add-category"
            (click)="addMarkupCategory()">
            <mat-icon>add</mat-icon>
            <span>Agregar Categoría</span>
          </button>
        </div>
      }
    </div>

    <!-- ========== CONFIGURACIÓN DE LA TABLA ========== -->
    @if (!isLoading && gridConfig()) {
      <section class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5 animate-fadeIn" style="animation-delay: 0.25s">
        <div class="flex items-center justify-between mb-4">
          <div class="flex items-center gap-3">
            <div class="flex items-center justify-center w-10 h-10 rounded-xl bg-blue-100">
              <mat-icon class="text-blue-600">table_chart</mat-icon>
            </div>
            <div>
              <h2 class="text-base font-semibold text-slate-800">Configuración de la Tabla</h2>
              <p class="text-xs text-slate-500">Personaliza el comportamiento de la tabla de datos</p>
            </div>
          </div>

          <button type="button"
                  [class]="allFeaturesEnabled()
                    ? 'px-3 py-1.5 bg-slate-600 hover:bg-slate-700 text-white text-xs font-medium rounded-lg transition-colors flex items-center gap-2'
                    : 'px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg transition-colors flex items-center gap-2'"
                  (click)="toggleAllFeatures()"
                  [disabled]="isLoading"
                  [title]="allFeaturesEnabled() ? 'Desactivar todas las funcionalidades' : 'Activar todas las funcionalidades'">
            <mat-icon class="text-base">{{ allFeaturesEnabled() ? 'cancel' : 'check_circle' }}</mat-icon>
            <span>{{ allFeaturesEnabled() ? 'Desactivar Todas' : 'Activar Todas' }}</span>
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          <!-- Enable Column Selector -->
          <div class="flex items-center justify-between p-3 rounded-lg border border-slate-200 hover:border-blue-300 transition-colors">
            <div class="flex items-center gap-3">
              <mat-icon class="text-slate-400">view_column</mat-icon>
              <div>
                <p class="text-sm font-medium text-slate-700">Selector de Columnas</p>
                <p class="text-xs text-slate-500">Permite ocultar/mostrar columnas</p>
              </div>
            </div>
            <button
              type="button"
              (click)="updateGridConfig('enableColumnSelector', !gridConfig().enableColumnSelector)"
              role="switch"
              [attr.aria-checked]="gridConfig().enableColumnSelector"
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
              [class.bg-blue-600]="gridConfig().enableColumnSelector"
              [class.bg-slate-300]="!gridConfig().enableColumnSelector">
              <span
                class="inline-block h-4 w-4 transform rounded-full bg-white shadow transition-transform"
                [class.translate-x-6]="gridConfig().enableColumnSelector"
                [class.translate-x-1]="!gridConfig().enableColumnSelector">
              </span>
            </button>
          </div>

          <!-- Enable Filters -->
          <div class="flex items-center justify-between p-3 rounded-lg border border-slate-200 hover:border-blue-300 transition-colors">
            <div class="flex items-center gap-3">
              <mat-icon class="text-slate-400">filter_list</mat-icon>
              <div>
                <p class="text-sm font-medium text-slate-700">Filtros</p>
                <p class="text-xs text-slate-500">Habilitar filtros de datos</p>
              </div>
            </div>
            <button
              type="button"
              (click)="updateGridConfig('enableFilters', !gridConfig().enableFilters)"
              role="switch"
              [attr.aria-checked]="gridConfig().enableFilters"
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
              [class.bg-blue-600]="gridConfig().enableFilters"
              [class.bg-slate-300]="!gridConfig().enableFilters">
              <span
                class="inline-block h-4 w-4 transform rounded-full bg-white shadow transition-transform"
                [class.translate-x-6]="gridConfig().enableFilters"
                [class.translate-x-1]="!gridConfig().enableFilters">
              </span>
            </button>
          </div>

          <!-- Enable Export -->
          <div class="flex items-center justify-between p-3 rounded-lg border border-slate-200 hover:border-blue-300 transition-colors">
            <div class="flex items-center gap-3">
              <mat-icon class="text-slate-400">download</mat-icon>
              <div>
                <p class="text-sm font-medium text-slate-700">Exportar</p>
                <p class="text-xs text-slate-500">Permitir exportar datos</p>
              </div>
            </div>
            <button
              type="button"
              (click)="updateGridConfig('enableExport', !gridConfig().enableExport)"
              role="switch"
              [attr.aria-checked]="gridConfig().enableExport"
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
              [class.bg-blue-600]="gridConfig().enableExport"
              [class.bg-slate-300]="!gridConfig().enableExport">
              <span
                class="inline-block h-4 w-4 transform rounded-full bg-white shadow transition-transform"
                [class.translate-x-6]="gridConfig().enableExport"
                [class.translate-x-1]="!gridConfig().enableExport">
              </span>
            </button>
          </div>

          <!-- Enable Bulk Actions -->
          <div class="flex items-center justify-between p-3 rounded-lg border border-slate-200 hover:border-blue-300 transition-colors">
            <div class="flex items-center gap-3">
              <mat-icon class="text-slate-400">done_all</mat-icon>
              <div>
                <p class="text-sm font-medium text-slate-700">Acciones Masivas</p>
                <p class="text-xs text-slate-500">Habilitar selección múltiple</p>
              </div>
            </div>
            <button
              type="button"
              (click)="updateGridConfig('enableBulkActions', !gridConfig().enableBulkActions)"
              role="switch"
              [attr.aria-checked]="gridConfig().enableBulkActions"
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
              [class.bg-blue-600]="gridConfig().enableBulkActions"
              [class.bg-slate-300]="!gridConfig().enableBulkActions">
              <span
                class="inline-block h-4 w-4 transform rounded-full bg-white shadow transition-transform"
                [class.translate-x-6]="gridConfig().enableBulkActions"
                [class.translate-x-1]="!gridConfig().enableBulkActions">
              </span>
            </button>
          </div>

          <!-- Enable Search -->
          <div class="flex items-center justify-between p-3 rounded-lg border border-slate-200 hover:border-blue-300 transition-colors">
            <div class="flex items-center gap-3">
              <mat-icon class="text-slate-400">search</mat-icon>
              <div>
                <p class="text-sm font-medium text-slate-700">Búsqueda</p>
                <p class="text-xs text-slate-500">Habilitar búsqueda global</p>
              </div>
            </div>
            <button
              type="button"
              (click)="updateGridConfig('enableSearch', !gridConfig().enableSearch)"
              role="switch"
              [attr.aria-checked]="gridConfig().enableSearch"
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
              [class.bg-blue-600]="gridConfig().enableSearch"
              [class.bg-slate-300]="!gridConfig().enableSearch">
              <span
                class="inline-block h-4 w-4 transform rounded-full bg-white shadow transition-transform"
                [class.translate-x-6]="gridConfig().enableSearch"
                [class.translate-x-1]="!gridConfig().enableSearch">
              </span>
            </button>
          </div>

          <!-- Compact Mode -->
          <div class="flex items-center justify-between p-3 rounded-lg border border-slate-200 hover:border-blue-300 transition-colors">
            <div class="flex items-center gap-3">
              <mat-icon class="text-slate-400">compress</mat-icon>
              <div>
                <p class="text-sm font-medium text-slate-700">Modo Compacto</p>
                <p class="text-xs text-slate-500">Reducir espaciado de filas</p>
              </div>
            </div>
            <button
              type="button"
              (click)="updateGridConfig('compactMode', !gridConfig().compactMode)"
              role="switch"
              [attr.aria-checked]="gridConfig().compactMode"
              class="relative inline-flex h-6 w-11 items-center rounded-full transition-colors focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
              [class.bg-blue-600]="gridConfig().compactMode"
              [class.bg-slate-300]="!gridConfig().compactMode">
              <span
                class="inline-block h-4 w-4 transform rounded-full bg-white shadow transition-transform"
                [class.translate-x-6]="gridConfig().compactMode"
                [class.translate-x-1]="!gridConfig().compactMode">
              </span>
            </button>
          </div>
        </div>

        <!-- Items Per Page -->
        <div class="mt-4 pt-4 border-t border-slate-200">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <mat-icon class="text-slate-400">format_list_numbered</mat-icon>
              <span class="text-sm font-medium text-slate-700">Elementos por Página</span>
            </div>
            <div class="flex gap-2">
              @for (option of pageSizeOptions; track option) {
                <button
                  type="button"
                  (click)="updateGridConfig('itemsPerPage', option)"
                  [class]="itemsPerPageSignal() === option
                    ? 'px-3 py-1.5 bg-blue-600 text-white text-xs font-medium rounded-lg transition-colors'
                    : 'px-3 py-1.5 bg-slate-100 hover:bg-slate-200 text-slate-700 text-xs font-medium rounded-lg transition-colors'">
                  {{ option }}
                </button>
              }
            </div>
          </div>
        </div>
      </section>
    }

    <!-- ========== TÉRMINOS Y CONDICIONES ========== -->
    <div class="config-section animate-fadeIn" style="animation-delay: 0.3s">
      <div class="section-header">
        <div class="section-icon green">
          <mat-icon>description</mat-icon>
        </div>
        <div>
          <h2>Términos y Condiciones</h2>
          <p>Este texto aparecerá automáticamente en todos los nuevos estimados</p>
        </div>
      </div>

      <div class="form-group">
        <textarea
          formControlName="defaultTerms"
          rows="10"
          class="form-textarea"
          placeholder="Ingresa los términos y condiciones por defecto..."></textarea>
      </div>
    </div>

    <!-- ========== BOTONES DE ACCIÓN ========== -->
    <div class="actions-bar animate-fadeIn" style="animation-delay: 0.35s">
      <div class="flex gap-2">
        <button type="button" class="btn-cancel" (click)="goBack()" [disabled]="isSaving()">
          <mat-icon>close</mat-icon>
          <span>Cancelar</span>
        </button>
        <button type="button" class="btn-secondary" (click)="resetToDefaults()" [disabled]="isSaving()">
          <mat-icon>refresh</mat-icon>
          <span>Restablecer</span>
        </button>
      </div>

      <button type="button" class="btn-save" (click)="saveConfig()" [disabled]="isSaving() || configForm.invalid">
        @if (isSaving()) {
          <div class="btn-spinner"></div>
        } @else {
          <mat-icon>save</mat-icon>
        }
        <span>Guardar Configuración</span>
      </button>
    </div>

  </form>

</div>
